---
title: JVM 03 è¿è¡Œæ—¶æ•°æ®åŒºä¹‹è™šæ‹Ÿæœºæ ˆ (Stack)
date: 2020-07-05 16:06:02
tags: [Java,JVM]
---

* 1 è™šæ‹Ÿæœºæ ˆæ¦‚è¿°
* 2 æ ˆçš„å­˜å‚¨å•ä½
* 3 å±€éƒ¨å˜é‡è¡¨
* 4 æ“ä½œæ•°æ ˆ
* 5 ä»£ç è¿½è¸ª
* 6 æ ˆé¡¶ç¼“å­˜æŠ€æœ¯
* 7 åŠ¨æ€é“¾æ¥
* 8 æ–¹æ³•çš„è°ƒç”¨:è§£æä¸åˆ†æ´¾
* 9 æ–¹æ³•è¿”å›åœ°å€
* 10 ä¸€äº›é™„åŠ ä¿¡æ¯
* 11 æ ˆçš„ç›¸å…³é¢è¯•é¢˜

<!-- more -->

## 1 è™šæ‹Ÿæœºæ ˆæ¦‚è¿°

ç”±äºè·¨å¹³å°æ€§çš„è®¾è®¡ï¼ŒJavaçš„æŒ‡ä»¤éƒ½æ˜¯æ ¹æ®æ ˆæ¥è®¾è®¡çš„ã€‚ä¸åŒå¹³å°CPUæ¶æ„ä¸åŒï¼Œæ‰€ä»¥ä¸èƒ½è®¾è®¡ä¸ºåŸºäºå¯„å­˜å™¨çš„ã€‚

**ä¼˜ç‚¹æ˜¯è·¨å¹³å°ï¼ŒæŒ‡ä»¤é›†å°ï¼Œç¼–è¯‘å™¨å®¹æ˜“å®ç°ï¼Œç¼ºç‚¹æ˜¯æ€§èƒ½ä¸‹é™ï¼Œå®ç°åŒæ ·çš„åŠŸèƒ½éœ€è¦æ›´å¤šçš„æŒ‡ä»¤ã€‚**

æœ‰ä¸å°‘Javaå¼€å‘äººå‘˜ä¸€æåˆ°Javaå†…å­˜ç»“æ„ï¼Œå°±ä¼šéå¸¸ç²—ç²’åº¦åœ°å°†JVMä¸­çš„å†…å­˜åŒºç†è§£ä¸ºä»…æœ‰Javaå †(heap)å’ŒJavaæ ˆ(stack)?ä¸ºä»€ä¹ˆ?

*ä¸å…¨é¢ã€‚ä¹Ÿè®¸å †å’Œæ ˆå¤ªé‡è¦ã€‚*

å†…å­˜ä¸­çš„æ ˆä¸å †

**æ ˆæ˜¯è¿è¡Œæ—¶çš„å•ä½ï¼Œè€Œå †æ˜¯å­˜å‚¨çš„å•ä½ã€‚**

å³: æ ˆè§£å†³ç¨‹åºçš„è¿è¡Œé—®é¢˜ï¼Œå³ç¨‹åºå¦‚ä½•æ‰§è¡Œï¼Œæˆ–è€…è¯´å¦‚ä½•å¤„ç†æ•°æ®ã€‚  å †è§£å†³çš„æ˜¯æ•°æ®å­˜å‚¨çš„é—®é¢˜ï¼Œå³æ•°æ®æ€ä¹ˆæ”¾ã€æ”¾åœ¨å“ªå„¿ã€‚

---

### è™šæ‹Ÿæœºæ ˆåŸºæœ¬å†…å®¹

â— **Javaè™šæ‹Ÿæœºæ ˆæ˜¯ä»€ä¹ˆ**?

Javaè™šæ‹Ÿæœºæ ˆ(Java Virtual Machine Stack) ï¼Œæ—©æœŸä¹Ÿå«Javaæ ˆã€‚æ¯ä¸ªçº¿ç¨‹åœ¨åˆ›å»ºæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºæ ˆï¼Œå…¶å†…éƒ¨ä¿å­˜ä¸€ä¸ªä¸ªçš„æ ˆå¸§(Stack Frame) ï¼Œå¯¹åº”ç€ä¸€æ¬¡æ¬¡çš„Javaæ–¹æ³•è°ƒç”¨ã€‚  
â¢ æ˜¯çº¿ç¨‹ç§æœ‰çš„

â— **ç”Ÿå‘½å‘¨æœŸ**

ç”Ÿå‘½å‘¨æœŸå’Œçº¿ç¨‹ä¸€è‡´ã€‚

â— **ä½œç”¨**

ä¸»ç®¡Javaç¨‹åºçš„è¿è¡Œï¼Œå®ƒä¿å­˜æ–¹æ³•çš„å±€éƒ¨å˜é‡ï¼ˆå…«ç§åŸºæœ¬æ•°æ®ç±»å‹ã€å¯¹è±¡çš„å¼•ç”¨åœ°å€ï¼‰ã€éƒ¨åˆ†ç»“æœï¼Œå¹¶å‚ä¸æ–¹æ³•çš„è°ƒç”¨å’Œè¿”å›ã€‚  
â¢ å±€éƒ¨å˜é‡ vs æˆå‘˜å˜é‡(æˆ–å±æ€§)  
â¢ åŸºæœ¬æ•°æ®å˜é‡ VS å¼•ç”¨ç±»å‹å˜é‡(ç±»ã€æ•°ç»„ã€æ¥å£)

---
æ ˆçš„ç‰¹ç‚¹(ä¼˜ç‚¹)

* â— æ ˆæ˜¯ä¸€ç§å¿«é€Ÿæœ‰æ•ˆçš„åˆ†é…å­˜å‚¨æ–¹å¼ï¼Œè®¿é—®é€Ÿåº¦ä»…æ¬¡äºç¨‹åºè®¡æ•°å™¨ã€‚
* â— JVMç›´æ¥ å¯¹Javaæ ˆçš„æ“ä½œåªæœ‰ä¸¤ä¸ª:  
  * â¢ æ¯ä¸ªæ–¹æ³•æ‰§è¡Œï¼Œä¼´éšç€è¿›æ ˆ(å…¥æ ˆã€å‹æ ˆ)  
  * â¢ æ‰§è¡Œç»“æŸåçš„å‡ºæ ˆå·¥ä½œ
* â— å¯¹äºæ ˆæ¥è¯´ä¸å­˜åœ¨åƒåœ¾å›æ”¶é—®é¢˜

---
é¢è¯•é¢˜: å¼€å‘ä¸­é‡åˆ°çš„å¼‚å¸¸æœ‰å“ªäº›?

æ ˆä¸­å¯èƒ½å‡ºç°çš„å¼‚å¸¸  
â— Javaè™šæ‹Ÿæœºè§„èŒƒ**å…è®¸Javaæ ˆçš„å¤§å°æ˜¯åŠ¨æ€çš„æˆ–è€…æ˜¯å›ºå®šä¸å˜çš„**ã€‚  
â¢ å¦‚æœé‡‡ç”¨å›ºå®šå¤§å°çš„Javaè™šæ‹Ÿæœºæ ˆï¼Œé‚£æ¯ä¸€ä¸ªçº¿ç¨‹çš„Javaè™šæ‹Ÿæœºæ ˆå®¹é‡å¯ä»¥åœ¨çº¿ç¨‹åˆ›å»ºçš„æ—¶å€™ç‹¬ç«‹é€‰å®šã€‚å¦‚æœçº¿ç¨‹è¯·æ±‚åˆ†é…çš„æ ˆå®¹é‡è¶…è¿‡Javaè™šæ‹Ÿæœºæ ˆå…è®¸çš„æœ€å¤§å®¹é‡ï¼ŒJava è™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ª `StackOverflowError` å¼‚å¸¸ã€‚  
â¢ å¦‚æœJavaè™›æ‹Ÿæœºæ ˆå¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œå¹¶ä¸”åœ¨å°è¯•æ‰©å±•çš„æ—¶å€™æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼Œæˆ–è€…åœ¨åˆ›å»ºæ–°çš„çº¿ç¨‹æ—¶æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å»åˆ›å»ºå¯¹åº”çš„è™šæ‹Ÿæœºæ ˆï¼Œé‚£Javaè™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ª `OutOfMemoryError` å¼‚å¸¸ã€‚

---
è®¾ç½®æ ˆå†…å­˜å¤§å°

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‚æ•° `-Xss` é€‰é¡¹æ¥è®¾ç½®çº¿ç¨‹çš„æœ€å¤§æ ˆç©ºé—´ï¼Œæ ˆçš„å¤§å°ç›´æ¥å†³å®šäº†å‡½æ•°è°ƒç”¨çš„æœ€å¤§å¯è¾¾æ·±åº¦ã€‚

IntelliJ IDEA è®¾ç½®æ ˆå¤§å°çš„æ–¹æ³•ï¼šç‚¹å‡» `Run` - `Edit Configurations` - `VM options` ï¼Œè¾“å…¥ `-Xss256K` æˆ– `-Xss256k` ï¼Œè®¾ç½®æ ˆçš„å¤§å°ä¸º256k ï¼ˆkã€mã€gæˆ–Kã€Mã€Gæ˜¯å•ä½ï¼Œå¤§å°å†™å‡å¯ï¼‰ã€‚

ä»¥ä¸‹è¿è¡Œç¯å¢ƒï¼šJava8ã€macOSã€‚ä¸‹é¢çš„ç¨‹åºè¾“å‡ºè§†è¿è¡Œç¯å¢ƒä¸åŒï¼ˆç³»ç»Ÿä¸åŒã€JDKç‰ˆæœ¬ä¸åŒå‡æœ‰å½±å“ï¼‰è€Œæœ‰ä¸åŒçš„ç»“æœã€‚

StackDeepTest.java

```java
package com.atguigu.java;

public class StackDeepTest {
    private static int count = 0;

    public static void recursion() {
        count++;
        recursion();
    }

    public static void main(String args[]) {
        try {
            recursion();
        } catch (Throwable e) {
            System.out.println("deep of calling = " + count);
            e.printStackTrace();
        }
    }
}
```

ä½¿ç”¨é»˜è®¤è®¾ç½®æ ˆçš„å¤§å°æ—¶ï¼Œç¨‹åºè¾“å‡ºï¼š

```java
deep of calling = 22387
java.lang.StackOverflowError
 at com.atguigu.java.StackDeepTest.recursion(StackDeepTest.java:8)
 at com.atguigu.java.StackDeepTest.recursion(StackDeepTest.java:8)
...
```

æŒ‡å®šæ ˆçš„å¤§å°ä¸º256Kæ—¶ï¼Œç¨‹åºè¾“å‡ºï¼š

```java
deep of calling = 2712
java.lang.StackOverflowError
 at com.atguigu.java.StackDeepTest.recursion(StackDeepTest.java:8)
 at com.atguigu.java.StackDeepTest.recursion(StackDeepTest.java:8)
...
```

---

StackErrorTest.java

```java
package com.atguigu.java;

/**
 * æ¼”ç¤ºæ ˆä¸­çš„å¼‚å¸¸:StackOverflowError
 * @author shkstart
 * @create 2020 ä¸‹åˆ 9:08
 *
 *  é»˜è®¤æƒ…å†µä¸‹ï¼šcount : 11420
 *  è®¾ç½®æ ˆçš„å¤§å°ï¼š -Xss256k : count : 2465
 */
public class StackErrorTest {
    private static int count = 1;
    public static void main(String[] args) {
        System.out.println(count);
        count++;
        main(args);
    }

}
```

---

## 2 æ ˆçš„å­˜å‚¨å•ä½

### æ ˆä¸­å­˜å‚¨ä»€ä¹ˆ

* æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„æ ˆï¼Œæ ˆä¸­çš„æ•°æ®éƒ½æ˜¯ä»¥ **æ ˆå¸§(Stack Frame) çš„æ ¼å¼å­˜åœ¨**ã€‚
* åœ¨è¿™ä¸ªçº¿ç¨‹ä¸Šæ­£åœ¨æ‰§è¡Œçš„æ¯ä¸ªæ–¹æ³•éƒ½å„è‡ªå¯¹åº”ä¸€ä¸ªæ ˆå¸§(Stack Frame )ã€‚
* æ ˆå¸§æ˜¯ä¸€ä¸ªå†…å­˜åŒºå—ï¼Œæ˜¯ä¸€ä¸ªæ•°æ®é›†ï¼Œç»´ç³»ç€æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å„ç§æ•°æ®ä¿¡æ¯ã€‚

### æ ˆè¿è¡ŒåŸç†

* JVMç›´æ¥å¯¹Javaæ ˆçš„æ“ä½œåªæœ‰ä¸¤ä¸ªï¼Œå°±æ˜¯å¯¹æ ˆå¸§çš„**å‹æ ˆ**å’Œ**å‡ºæ ˆ**ï¼Œéµå¾ªâ€œå…ˆè¿›åå‡ºâ€/â€œåè¿›å…ˆå‡ºâ€åŸåˆ™ã€‚
* åœ¨ä¸€æ¡æ´»åŠ¨çº¿ç¨‹ä¸­ï¼Œä¸€ä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œåªä¼šæœ‰ä¸€ä¸ªæ´»åŠ¨çš„æ ˆå¸§ã€‚å³åªæœ‰å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•çš„æ ˆå¸§(æ ˆé¡¶æ ˆå¸§)æ˜¯æœ‰æ•ˆçš„ï¼Œè¿™ä¸ªæ ˆå¸§è¢«ç§°ä¸º**å½“å‰æ ˆå¸§(Current Frame)**ï¼Œä¸å½“å‰æ ˆå¸§ç›¸å¯¹åº”çš„æ–¹æ³•å°±æ˜¯**å½“å‰æ–¹æ³•(CurrentMethod)**ï¼Œå®šä¹‰è¿™ä¸ªæ–¹æ³•çš„ç±»å°±æ˜¯**å½“å‰ç±»(Current Class)**ã€‚
* æ‰§è¡Œå¼•æ“è¿è¡Œçš„æ‰€æœ‰å­—èŠ‚ç æŒ‡ä»¤åªé’ˆå¯¹å½“å‰æ ˆå¸§è¿›è¡Œæ“ä½œã€‚
* å¦‚æœåœ¨è¯¥æ–¹æ³•ä¸­è°ƒç”¨äº†å…¶ä»–æ–¹æ³•ï¼Œå¯¹åº”çš„æ–°çš„æ ˆå¸§ä¼šè¢«åˆ›å»ºå‡ºæ¥ï¼Œæ”¾åœ¨æ ˆçš„é¡¶ç«¯ï¼Œæˆä¸ºæ–°çš„å½“å‰å¸§ã€‚
* ä¸åŒçº¿ç¨‹ä¸­æ‰€åŒ…å«çš„æ ˆå¸§æ˜¯ä¸å…è®¸å­˜åœ¨ç›¸äº’å¼•ç”¨çš„ï¼Œå³ä¸å¯èƒ½åœ¨ä¸€ä¸ªæ ˆå¸§ä¹‹ä¸­å¼•ç”¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„æ ˆå¸§ã€‚
* å¦‚æœå½“å‰æ–¹æ³•è°ƒç”¨äº†å…¶ä»–æ–¹æ³•ï¼Œæ–¹æ³•è¿”å›ä¹‹é™…ï¼Œå½“å‰æ ˆå¸§ä¼šä¼ å›æ­¤æ–¹æ³•çš„æ‰§è¡Œç»“æœç»™å‰ä¸€ä¸ªæ ˆå¸§ï¼Œæ¥ç€ï¼Œè™šæ‹Ÿæœºä¼šä¸¢å¼ƒå½“å‰æ ˆå¸§ï¼Œä½¿å¾—å‰ä¸€ä¸ªæ ˆå¸§é‡æ–°æˆä¸ºå½“å‰æ ˆå¸§ã€‚
* Javaæ–¹æ³•æœ‰ä¸¤ç§è¿”å›å‡½æ•°çš„æ–¹å¼ï¼Œä¸€ç§æ˜¯æ­£å¸¸çš„å‡½æ•°è¿”å›ï¼Œä½¿ç”¨returnæŒ‡ä»¤;å¦å¤–ä¸€ç§æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼ˆæ²¡æœ‰å¤„ç†çš„å¼‚å¸¸ï¼‰ã€‚ä¸ç®¡ä½¿ç”¨å“ªç§æ–¹å¼ï¼Œéƒ½ä¼šå¯¼è‡´æ ˆå¸§è¢«å¼¹å‡ºã€‚

StackFrameTest.java

```java
package com.atguigu.java1;

/**
 * @author shkstart
 * @create 2020 ä¸‹åˆ 4:11
 * <p>
 * æ–¹æ³•çš„ç»“æŸæ–¹å¼åˆ†ä¸ºä¸¤ç§ï¼šâ‘  æ­£å¸¸ç»“æŸï¼Œä»¥returnä¸ºä»£è¡¨  â‘¡ æ–¹æ³•æ‰§è¡Œä¸­å‡ºç°æœªæ•è·å¤„ç†çš„å¼‚å¸¸ï¼Œä»¥æŠ›å‡ºå¼‚å¸¸çš„æ–¹å¼ç»“æŸ
 */
public class StackFrameTest {
    public static void main(String[] args) {
        try {
            StackFrameTest test = new StackFrameTest();
            test.method1();

        } catch (Exception e) {
            e.printStackTrace();
        }

        System.out.println("main()æ­£å¸¸ç»“æŸ");

    }

    public void method1() {
        System.out.println("method1()å¼€å§‹æ‰§è¡Œ...");
        method2();
        System.out.println("method1()æ‰§è¡Œç»“æŸ...");
        //        System.out.println(10 / 0);

        //        return ;//å¯ä»¥çœç•¥
    }

    public int method2() {
        System.out.println("method2()å¼€å§‹æ‰§è¡Œ...");
        int i = 10;
        int m = (int) method3();
        System.out.println("method2()å³å°†ç»“æŸ...");
        return i + m;
    }

    public double method3() {
        System.out.println("method3()å¼€å§‹æ‰§è¡Œ...");
        double j = 20.0;
        System.out.println("method3()å³å°†ç»“æŸ...");
        return j;
    }

}
```

åç¼–è¯‘StackFrameTest.class

```java
$ javap StackFrameTest.class
Compiled from "StackFrameTest.java"
public class com.atguigu.java1.StackFrameTest {
  public com.atguigu.java1.StackFrameTest();
  public static void main(java.lang.String[]);
  public void method1();
  public int method2();
  public double method3();
}

$ javap -v StackFrameTest.class
Classfile /Users/yan/Documents/JVMDemo/out/production/chapter05/com/atguigu/java1/StackFrameTest.class
  Last modified 2020å¹´7æœˆ5æ—¥; size 1373 bytes
  SHA-256 checksum c61db00f51e8ffb48977aa8245b58fb7b3e49f4678d4e147dffdd989f0a43478
  Compiled from "StackFrameTest.java"
public class com.atguigu.java1.StackFrameTest
  minor version: 0
  major version: 52
  flags: (0x0021) ACC_PUBLIC, ACC_SUPER
  this_class: #2                          // com/atguigu/java1/StackFrameTest
  super_class: #20                        // java/lang/Object
  interfaces: 0, fields: 0, methods: 5, attributes: 1
Constant pool:
   #1 = Methodref          #20.#49        // java/lang/Object."<init>":()V
   #2 = Class              #50            // com/atguigu/java1/StackFrameTest
   #3 = Methodref          #2.#49         // com/atguigu/java1/StackFrameTest."<init>":()V
   #4 = Methodref          #2.#51         // com/atguigu/java1/StackFrameTest.method1:()V
   #5 = Class              #52            // java/lang/Exception
   #6 = Methodref          #5.#53         // java/lang/Exception.printStackTrace:()V
   #7 = Fieldref           #54.#55        // java/lang/System.out:Ljava/io/PrintStream;
   #8 = String             #56            // main()æ­£å¸¸ç»“æŸ
   #9 = Methodref          #57.#58        // java/io/PrintStream.println:(Ljava/lang/String;)V
  #10 = String             #59            // method1()å¼€å§‹æ‰§è¡Œ...
  #11 = Methodref          #2.#60         // com/atguigu/java1/StackFrameTest.method2:()I
  #12 = String             #61            // method1()æ‰§è¡Œç»“æŸ...
  #13 = String             #62            // method2()å¼€å§‹æ‰§è¡Œ...
  #14 = Methodref          #2.#63         // com/atguigu/java1/StackFrameTest.method3:()D
  #15 = String             #64            // method2()å³å°†ç»“æŸ...
  #16 = String             #65            // method3()å¼€å§‹æ‰§è¡Œ...
  #17 = Double             20.0d
  #19 = String             #66            // method3()å³å°†ç»“æŸ...
  #20 = Class              #67            // java/lang/Object
  #21 = Utf8               <init>
  #22 = Utf8               ()V
  #23 = Utf8               Code
  #24 = Utf8               LineNumberTable
  #25 = Utf8               LocalVariableTable
  #26 = Utf8               this
  #27 = Utf8               Lcom/atguigu/java1/StackFrameTest;
  #28 = Utf8               main
  #29 = Utf8               ([Ljava/lang/String;)V
  #30 = Utf8               test
  #31 = Utf8               e
  #32 = Utf8               Ljava/lang/Exception;
  #33 = Utf8               args
  #34 = Utf8               [Ljava/lang/String;
  #35 = Utf8               StackMapTable
  #36 = Class              #52            // java/lang/Exception
  #37 = Utf8               method1
  #38 = Utf8               method2
  #39 = Utf8               ()I
  #40 = Utf8               i
  #41 = Utf8               I
  #42 = Utf8               m
  #43 = Utf8               method3
  #44 = Utf8               ()D
  #45 = Utf8               j
  #46 = Utf8               D
  #47 = Utf8               SourceFile
  #48 = Utf8               StackFrameTest.java
  #49 = NameAndType        #21:#22        // "<init>":()V
  #50 = Utf8               com/atguigu/java1/StackFrameTest
  #51 = NameAndType        #37:#22        // method1:()V
  #52 = Utf8               java/lang/Exception
  #53 = NameAndType        #68:#22        // printStackTrace:()V
  #54 = Class              #69            // java/lang/System
  #55 = NameAndType        #70:#71        // out:Ljava/io/PrintStream;
  #56 = Utf8               main()æ­£å¸¸ç»“æŸ
  #57 = Class              #72            // java/io/PrintStream
  #58 = NameAndType        #73:#74        // println:(Ljava/lang/String;)V
  #59 = Utf8               method1()å¼€å§‹æ‰§è¡Œ...
  #60 = NameAndType        #38:#39        // method2:()I
  #61 = Utf8               method1()æ‰§è¡Œç»“æŸ...
  #62 = Utf8               method2()å¼€å§‹æ‰§è¡Œ...
  #63 = NameAndType        #43:#44        // method3:()D
  #64 = Utf8               method2()å³å°†ç»“æŸ...
  #65 = Utf8               method3()å¼€å§‹æ‰§è¡Œ...
  #66 = Utf8               method3()å³å°†ç»“æŸ...
  #67 = Utf8               java/lang/Object
  #68 = Utf8               printStackTrace
  #69 = Utf8               java/lang/System
  #70 = Utf8               out
  #71 = Utf8               Ljava/io/PrintStream;
  #72 = Utf8               java/io/PrintStream
  #73 = Utf8               println
  #74 = Utf8               (Ljava/lang/String;)V
{
  public com.atguigu.java1.StackFrameTest();
    descriptor: ()V
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object."<init>":()V
         4: return
      LineNumberTable:
        line 9: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       5     0  this   Lcom/atguigu/java1/StackFrameTest;

  public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: (0x0009) ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=2, args_size=1
         0: new           #2                  // class com/atguigu/java1/StackFrameTest
         3: dup
         4: invokespecial #3                  // Method "<init>":()V
         7: astore_1
         8: aload_1
         9: invokevirtual #4                  // Method method1:()V
        12: goto          20
        15: astore_1
        16: aload_1
        17: invokevirtual #6                  // Method java/lang/Exception.printStackTrace:()V
        20: getstatic     #7                  // Field java/lang/System.out:Ljava/io/PrintStream;
        23: ldc           #8                  // String main()æ­£å¸¸ç»“æŸ
        25: invokevirtual #9                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
        28: return
      Exception table:
         from    to  target type
             0    12    15   Class java/lang/Exception
      LineNumberTable:
        line 12: 0
        line 13: 8
        line 17: 12
        line 15: 15
        line 16: 16
        line 19: 20
        line 21: 28
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            8       4     1  test   Lcom/atguigu/java1/StackFrameTest;
           16       4     1     e   Ljava/lang/Exception;
            0      29     0  args   [Ljava/lang/String;
      StackMapTable: number_of_entries = 2
        frame_type = 79 /* same_locals_1_stack_item */
          stack = [ class java/lang/Exception ]
        frame_type = 4 /* same */

  public void method1();
    descriptor: ()V
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=2, locals=1, args_size=1
         0: getstatic     #7                  // Field java/lang/System.out:Ljava/io/PrintStream;
         3: ldc           #10                 // String method1()å¼€å§‹æ‰§è¡Œ...
         5: invokevirtual #9                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
         8: aload_0
         9: invokevirtual #11                 // Method method2:()I
        12: pop
        13: getstatic     #7                  // Field java/lang/System.out:Ljava/io/PrintStream;
        16: ldc           #12                 // String method1()æ‰§è¡Œç»“æŸ...
        18: invokevirtual #9                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
        21: return
      LineNumberTable:
        line 24: 0
        line 25: 8
        line 26: 13
        line 30: 21
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      22     0  this   Lcom/atguigu/java1/StackFrameTest;

  public int method2();
    descriptor: ()I
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=2, locals=3, args_size=1
         0: getstatic     #7                  // Field java/lang/System.out:Ljava/io/PrintStream;
         3: ldc           #13                 // String method2()å¼€å§‹æ‰§è¡Œ...
         5: invokevirtual #9                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
         8: bipush        10
        10: istore_1
        11: aload_0
        12: invokevirtual #14                 // Method method3:()D
        15: d2i
        16: istore_2
        17: getstatic     #7                  // Field java/lang/System.out:Ljava/io/PrintStream;
        20: ldc           #15                 // String method2()å³å°†ç»“æŸ...
        22: invokevirtual #9                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
        25: iload_1
        26: iload_2
        27: iadd
        28: ireturn
      LineNumberTable:
        line 33: 0
        line 34: 8
        line 35: 11
        line 36: 17
        line 37: 25
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      29     0  this   Lcom/atguigu/java1/StackFrameTest;
           11      18     1     i   I
           17      12     2     m   I

  public double method3();
    descriptor: ()D
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=2, locals=3, args_size=1
         0: getstatic     #7                  // Field java/lang/System.out:Ljava/io/PrintStream;
         3: ldc           #16                 // String method3()å¼€å§‹æ‰§è¡Œ...
         5: invokevirtual #9                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
         8: ldc2_w        #17                 // double 20.0d
        11: dstore_1
        12: getstatic     #7                  // Field java/lang/System.out:Ljava/io/PrintStream;
        15: ldc           #19                 // String method3()å³å°†ç»“æŸ...
        17: invokevirtual #9                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
        20: dload_1
        21: dreturn
      LineNumberTable:
        line 41: 0
        line 42: 8
        line 43: 12
        line 44: 20
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      22     0  this   Lcom/atguigu/java1/StackFrameTest;
           12      10     1     j   D
}
SourceFile: "StackFrameTest.java"

```

`return`, `ireturn`, `dreturn` ä¸­ `i` ä»£è¡¨ intï¼Œ `d` ä»£è¡¨ doubleã€‚

### â—† æ ˆå¸§çš„å†…éƒ¨ç»“æ„

![æ ˆå¸§çš„å†…éƒ¨ç»“æ„](æ ˆå¸§1.png)

æ¯ä¸ªæ ˆå¸§ä¸­å­˜å„²ç€:

* **å±€éƒ¨å˜é‡è¡¨(Local Variables)**
* **æ“ä½œæ•°æ ˆ(Operand Stack) ( æˆ–è¡¨è¾¾å¼æ ˆ)**
* åŠ¨æ€é“¾æ¥(Dynamic Linking) ( æˆ–æŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± çš„æ–¹æ³•å¼•ç”¨)
* æ–¹æ³•è¿”å›åœ°å€(Return Address) (æˆ–æ–¹æ³•æ­£å¸¸é€€å‡ºæˆ–è€…å¼‚å¸¸é€€å‡ºçš„å®šä¹‚)
* ä¸€äº›é™„åŠ ä¿¡æ¯

---

## 3 ğŸŒ¿ å±€éƒ¨å˜é‡è¡¨

* å±€éƒ¨å˜é‡è¡¨ä¹Ÿè¢«ç§°ä¹‹ä¸ºå±€éƒ¨å˜é‡æ•°ç»„æˆ–æœ¬åœ°å˜é‡è¡¨
* **å®šä¹‰ä¸ºä¸€ä¸ªæ•°å­—æ•°ç»„ï¼Œä¸»è¦ç”¨äºå­˜å‚¨æ–¹æ³•å‚æ•°å’Œå®šä¹‰åœ¨æ–¹æ³•ä½“å†…çš„å±€éƒ¨å˜é‡**ï¼Œè¿™äº›æ•°æ®ç±»å‹åŒ…æ‹¬å„ç±»æœ¬æ•°æ®ç±»å‹ã€å¯¹è±¡å¼•ç”¨(reference) ï¼Œä»¥åŠreturnAddressç±»å‹ã€‚
* ç”±äºå±€éƒ¨å˜é‡è¡¨æ˜¯å»ºç«‹åœ¨çº¿ç¨‹çš„æ ˆä¸Šï¼Œæ˜¯çº¿ç¨‹çš„ç§æœ‰æ•°æ®ï¼Œå› æ­¤**ä¸å­˜åœ¨æ•°æ®å®‰å…¨é—®é¢˜**
* **å±€éƒ¨å˜é‡è¡¨æ‰€éœ€çš„å®¹é‡å¤§å°æ˜¯åœ¨ç¼–è¯‘æœŸç¡®å®šä¸‹æ¥çš„**ï¼Œå¹¶ä¿å­˜åœ¨æ–¹æ³•çš„Codeå±æ€§çš„ `maximum local variables` æ•°æ®é¡¹ä¸­ã€‚åœ¨æ–¹æ³•è¿è¡ŒæœŸé—´æ˜¯ä¸ä¼šæ”¹å˜å±€éƒ¨å˜é‡è¡¨çš„å¤§å°çš„ã€‚

* **æ–¹æ³•åµŒå¥—è°ƒç”¨çš„æ¬¡æ•°ç”±æ ˆçš„å¤§å°å†³å®š**ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ ˆè¶Šå¤§ï¼Œæ–¹æ³•åµŒå¥—è°ƒç”¨æ¬¡æ•°è¶Šå¤šã€‚å¯¹ä¸€ä¸ªå‡½æ•°è€Œè¨€ï¼Œå®ƒçš„å‚æ•°å’Œå±€éƒ¨å˜é‡è¶Šå¤šï¼Œä½¿å¾—å±€éƒ¨å˜é‡è¡¨è†¨èƒ€ï¼Œå®ƒçš„æ ˆå¸§å°±è¶Šå¤§ï¼Œä»¥æ»¡è¶³æ–¹æ³•è°ƒç”¨æ‰€éœ€ä¼ é€’çš„ä¿¡æ¯å¢å¤§çš„éœ€æ±‚ã€‚è¿›è€Œå‡½æ•°è°ƒç”¨å°±ä¼šå ç”¨æ›´å¤šçš„æ ˆç©ºé—´ï¼Œå¯¼è‡´å…¶åµŒå¥—è°ƒç”¨æ¬¡æ•°å°±ä¼šå‡å°‘ã€‚
* **å±€éƒ¨å˜é‡è¡¨ä¸­çš„å˜é‡åªåœ¨å½“å‰æ–¹æ³•è°ƒç”¨ä¸­æœ‰æ•ˆ**ã€‚åœ¨æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œè™šæ‹Ÿæœºé€šè¿‡ä½¿ç”¨å±€éƒ¨å˜é‡è¡¨å®Œæˆå‚æ•°å€¼åˆ°å‚æ•°å˜é‡åˆ—è¡¨çš„ä¼ é€’è¿‡ç¨‹ã€‚**å½“æ–¹æ³•è°ƒç”¨ç»“æŸåï¼Œéšç€æ–¹æ³•æ ˆå¸§çš„é”€æ¯ï¼Œå±€éƒ¨å˜é‡è¡¨ä¹Ÿä¼šéšä¹‹é”€æ¯**ã€‚

### å­—èŠ‚ç ä¸­æ–¹æ³•å†…éƒ¨ç»“æ„çš„å‰–æ

ä»¥mainæ–¹æ³•ä¸ºä¾‹ï¼š

```java
    public static void main(String[] args) {
        LocalVariablesTest test = new LocalVariablesTest();
        int num = 10;
        test.test1();
    }
```

`javap -v` å¾—åˆ°çš„å†…å®¹ï¼Œmainæ–¹æ³•éƒ¨åˆ†ï¼š

```java
  public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: (0x0009) ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=3, args_size=1
         0: new           #1                  // class com/atguigu/java1/LocalVariablesTest
         3: dup
         4: invokespecial #2                  // Method "<init>":()V
         7: astore_1
         8: bipush        10
        10: istore_2
        11: aload_1
        12: invokevirtual #3                  // Method test1:()V
        15: return
      LineNumberTable:
        line 13: 0
        line 14: 8
        line 15: 11
        line 16: 15
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      16     0  args   [Ljava/lang/String;
            8       8     1  test   Lcom/atguigu/java1/LocalVariablesTest;
           11       5     2   num   I
```

ä»¥ä¸Šä¿¡æ¯ä¸­ï¼š  

è¿™äº›ä¸œè¥¿ | æ˜¯å•¥æ„æ€ï¼Ÿ
------- | -------
descriptor: ([Ljava/lang/String;)V | æè¿°ç¬¦ï¼š[è¡¨ç¤ºä¸€ç»´æ•°ç»„ï¼ŒLè¡¨ç¤ºå¼•ç”¨ç±»å‹å˜é‡ï¼ŒVè¡¨ç¤ºæ–¹æ³•è¿”å›å€¼ `void`
flags: (0x0009) ACC_PUBLIC, ACC_STATIC | Access flagså³è®¿é—®æ ‡è¯† `public static`
Code: | å­—èŠ‚ç ï¼š
stack=2, locals=3, args_size=1 | locals=3è¡¨ç¤ºå±€éƒ¨å˜é‡è¡¨æ·±åº¦ä¸º3ï¼Œstack=2è¡¨ç¤ºæ“ä½œæ•°æ ˆæ·±åº¦ä¸º2
Code: 0åˆ°15 | å­—èŠ‚ç æŒ‡ä»¤å·
LineNumberTable line 13: 0 | è¡Œå·è¡¨ line 13è¡¨ç¤ºjavaæºä»£ç ä¸­çš„è¡Œå·13: 0è¡¨ç¤ºå­—èŠ‚ç æŒ‡ä»¤å·0
LocalVariableTableï¼šStart Length Slot | å±€éƒ¨å˜é‡è¡¨ï¼šStartå’ŒLengthåœ¨ä¸€èµ·è¡¨ç¤ºäº†å±€éƒ¨å˜é‡çš„ä½œç”¨èŒƒå›´ï¼šå­—èŠ‚ç æŒ‡ä»¤ä¸­ä»Startå¼€å§‹ï¼Œé•¿åº¦ä¸ºLengthï¼ŒSlotä¸ºæ§½çš„ç´¢å¼•

### å…³äºSlotçš„ç†è§£

* å‚æ•°å€¼çš„å­˜æ”¾æ€»æ˜¯åœ¨å±€éƒ¨å˜é‡æ•°ç»„çš„index0å¼€å§‹ï¼Œåˆ°æ•°ç»„é•¿åº¦-1çš„ç´¢å¼•ç»“æŸã€‚
* **å±€éƒ¨å˜é‡è¡¨ï¼Œæœ€åŸºæœ¬çš„å­˜å‚¨å•å…ƒæ˜¯Slot (å˜é‡æ§½)**
* å±€éƒ¨å˜é‡è¡¨ä¸­å­˜æ”¾ç¼–è¯‘æœŸå¯çŸ¥çš„å„ç§åŸºæœ¬æ•°æ®ç±»å‹(8ç§)ï¼Œå¼•ç”¨ç±»å‹(reference)ï¼ŒreturnAddressç±»å‹ã€‚
* **åœ¨å±€éƒ¨å˜é‡è¡¨é‡Œï¼Œ32ä½ä»¥å†…çš„ç±»å‹åªå ç”¨ä¸€ä¸ªslot (åŒ…æ‹¬returnAddressç±»å‹)ï¼Œ64ä½çš„ç±»å‹(longå’Œdouble)å ç”¨ä¸¤ä¸ªslot**ã€‚
  * â¢ byteã€shortã€char åœ¨å­˜å‚¨å‰è¢«è½¬æ¢ä¸ºint, booleanä¹Ÿè¢«è½¬æ¢ä¸ºintï¼Œ0è¡¨ç¤ºfalse, é0è¡¨ç¤ºtrueã€‚
  * â¢ longå’Œdouble åˆ™å æ®ä¸¤ä¸ªSlotã€‚

![å˜é‡æ§½Slot](å˜é‡æ§½Slot1.png)

* JVMä¼šä¸ºå±€éƒ¨å˜é‡è¡¨ä¸­çš„æ¯ä¸€ä¸ªSlotéƒ½åˆ†é…ä¸€ä¸ªè®¿é—®ç´¢å¼•ï¼Œé€šè¿‡è¿™ä¸ªç´¢å¼•å³å¯æˆåŠŸè®¿é—®åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­æŒ‡å®šçš„å±€éƒ¨å˜é‡å€¼
* å½“ä¸€ä¸ªå®ä¾‹æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå®ƒçš„æ–¹æ³•å‚æ•°å’Œæ–¹æ³•ä½“å†…éƒ¨å®šä¹‰çš„å±€éƒ¨å˜é‡å°†ä¼š**æŒ‰ç…§é¡ºåºè¢«å¤åˆ¶**åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­çš„æ¯ä¸€ä¸ªslotä¸Š
* **å¦‚æœéœ€è¦è®¿é—®å±€éƒ¨å˜é‡è¡¨ä¸­ä¸€ä¸ª64bitçš„å±€éƒ¨å˜é‡å€¼æ—¶ï¼Œåªéœ€è¦ä½¿ç”¨å‰ä¸€ä¸ªç´¢å¼•å³å¯**ã€‚(æ¯”å¦‚:è®¿é—®longæˆ–doubleç±»å‹å˜é‡)
* å¦‚æœå½“å‰å¸§æ˜¯ç”±æ„é€ æ–¹æ³•æˆ–è€…å®ä¾‹æ–¹æ³•åˆ›å»ºçš„ï¼Œé‚£ä¹ˆ**è¯¥å¯¹è±¡å¼•ç”¨thiså°†ä¼šå­˜æ”¾åœ¨indexä¸º0çš„slotå¤„**ï¼Œå…¶ä½™çš„å‚æ•°æŒ‰ç…§å‚æ•°è¡¨é¡ºåºç»§ç»­æ’åˆ—ã€‚

åˆå¦‚ test2 æ–¹æ³•ï¼š

```java
public String test2(Date dateP, String name2) {
    dateP = null;
    name2 = "songhongkang";
    double weight = 130.5;//å æ®ä¸¤ä¸ªslot
    char gender = 'ç”·';
    return dateP + name2;
}
```

test2æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨å¦‚ä¸‹ï¼šå…¶ä¸­slot index0æ˜¯å¯¹è±¡å¼•ç”¨`this`ï¼Œslot index3å’Œ4æ˜¯`double`ç±»å‹çš„å˜é‡ï¼ˆåªéœ€è¦ç´¢å¼•index 3å³å¯è®¿é—®doubleç±»å‹çš„å˜é‡weightï¼‰ï¼Œslot index5æ˜¯`char`ç±»å‹å˜é‡ã€‚

```java
public java.lang.String test2(java.util.Date, java.lang.String);
  descriptor: (Ljava/util/Date;Ljava/lang/String;)Ljava/lang/String;
  flags: (0x0001) ACC_PUBLIC
  Code:
    stack=2, locals=6, args_size=3
       0: aconst_null
       1: astore_1
       2: ldc           #18                 // String songhongkang

    .......ä¸­é—´çœç•¥.........

    LocalVariableTable:
      Start  Length  Slot  Name   Signature
          0      33     0  this   Lcom/atguigu/java1/LocalVariablesTest;
          0      33     1 dateP   Ljava/util/Date;
          0      33     2 name2   Ljava/lang/String;
          9      24     3 weight   D
         14      19     5 gender   C
```

### Slotçš„é‡å¤åˆ©ç”¨

**æ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡è¡¨ä¸­çš„æ§½ä½æ˜¯å¯ä»¥é‡ç”¨çš„**ï¼Œå¦‚æœä¸€ä¸ªå±€éƒ¨å˜é‡è¿‡äº†å…¶ä½œç”¨åŸŸï¼Œé‚£ä¹ˆåœ¨å…¶ä½œç”¨åŸŸä¹‹åç”³æ˜çš„æ–°çš„å±€éƒ¨å˜é‡å°±å¾ˆæœ‰å¯èƒ½ä¼šå¤ç”¨è¿‡æœŸå±€éƒ¨å˜é‡çš„æ§½ä½ï¼Œä»è€Œ**è¾¾åˆ°èŠ‚çœèµ„æºçš„ç›®çš„**ã€‚test4æ–¹æ³•æ¼”ç¤ºäº†è¿™ä¸€ç‚¹ï¼š

```java
public void test4() {
    int a = 0;
    {
        int b = 0;
        b = a + 1;
    }
    //å˜é‡cä½¿ç”¨ä¹‹å‰å·²ç»é”€æ¯çš„å˜é‡bå æ®çš„slotçš„ä½ç½®
    int c = a + 1;
}
```

ä¸‹é¢æ˜¯ `javap -v` å¾—åˆ°çš„test4æ–¹æ³•éƒ¨åˆ†çš„å±€éƒ¨å˜é‡è¡¨ LocalVariableTable:

```java
public void test4();
  descriptor: ()V
  flags: (0x0001) ACC_PUBLIC
  Code:
    stack=2, locals=3, args_size=1
       0: iconst_0
       1: istore_1
       2: iconst_0
       3: istore_2
       4: iload_1
       5: iconst_1
       6: iadd
       7: istore_2
       8: iload_1
       9: iconst_1
      10: iadd
      11: istore_2
      12: return
    LineNumberTable:
      line 53: 0
      line 55: 2
      line 56: 4
      line 59: 8
      line 60: 12
    LocalVariableTable:
      Start  Length  Slot  Name   Signature
          4       4     2     b   I
          0      13     0  this   Lcom/atguigu/java1/LocalVariablesTest;
          2      11     1     a   I
         12       1     2     c   I
```

ä» LocalVariableTable å¯ä»¥çœ‹å‡ºï¼Œå±€éƒ¨å˜é‡ *b* çš„ä½œç”¨åŸŸèŒƒå›´æ˜¯4ï¼ˆStartï¼‰åˆ°8ï¼ˆStart+Lengthï¼‰ï¼Œå³test4æ–¹æ³•ä¸­ç”¨ `{` å’Œ `}` æ‹¬èµ·æ¥çš„éƒ¨åˆ†ã€‚ä»9å¼€å§‹ï¼ŒSlot 2è¿™ä¸ªæ§½å®é™…å°±ç›¸å½“äºç©ºç€äº†ï¼Œæ‰€ä»¥å±€éƒ¨å˜é‡ *c* çš„ä½œç”¨åŸŸèŒƒå›´ä»12å¼€å§‹ï¼Œå±€éƒ¨å˜é‡ *c* å°±é‡å¤åˆ©ç”¨äº†è¿‡æœŸå±€éƒ¨å˜é‡ *b* çš„æ§½ä½ã€‚

### ä¸¾ä¾‹:é™æ€å˜é‡ä¸å±€éƒ¨å˜é‡çš„å¯¹æ¯”

â— å‚æ•°è¡¨åˆ†é…å®Œæ¯•ä¹‹åï¼Œå†æ ¹æ®æ–¹æ³•ä½“å†…å®šä¹‰çš„å˜é‡çš„é¡ºåºå’Œä½œç”¨åŸŸåˆ†é…ã€‚  
â— æˆ‘ä»¬çŸ¥é“ç±»å˜é‡è¡¨æœ‰ä¸¤æ¬¡åˆå§‹åŒ–çš„æœºä¼šï¼Œç¬¬ä¸€æ¬¡æ˜¯åœ¨â€œ**å‡†å¤‡é˜¶æ®µ**â€ï¼Œæ‰§è¡Œç³»ç»Ÿåˆå§‹åŒ–ï¼Œå¯¹ç±»å˜é‡è®¾ç½®é›¶å€¼ï¼Œå¦ä¸€æ¬¡åˆ™æ˜¯åœ¨â€œ**åˆå§‹åŒ–**â€é˜¶æ®µï¼Œèµ‹äºˆç¨‹åºå‘˜åœ¨ä»£ç ä¸­å®šä¹‰çš„åˆå§‹å€¼ã€‚  
â— å’Œç±»å˜é‡åˆå§‹åŒ–ä¸åŒçš„æ˜¯ï¼Œå±€éƒ¨å˜é‡è¡¨ä¸å­˜åœ¨ç³»ç»Ÿåˆå§‹åŒ–çš„è¿‡ç¨‹ï¼Œè¿™æ„å‘³ç€ä¸€æ—¦å®šä¹‰äº†å±€éƒ¨å˜é‡åˆ™å¿…é¡»äººä¸ºçš„åˆå§‹åŒ–ï¼Œå¦åˆ™æ— æ³•ä½¿ç”¨ã€‚

```java
/*
    å˜é‡çš„åˆ†ç±»ï¼šæŒ‰ç…§æ•°æ®ç±»å‹åˆ†ï¼š
    â‘  åŸºæœ¬æ•°æ®ç±»å‹  â‘¡ å¼•ç”¨æ•°æ®ç±»å‹
    æŒ‰ç…§åœ¨ç±»ä¸­å£°æ˜çš„ä½ç½®åˆ†ï¼š
    â‘  æˆå‘˜å˜é‡ï¼šåœ¨ä½¿ç”¨å‰ï¼Œéƒ½ç»å†è¿‡é»˜è®¤åˆå§‹åŒ–èµ‹å€¼
      ç±»å˜é‡ï¼š linkingçš„prepareé˜¶æ®µï¼šç»™ç±»å˜é‡é»˜è®¤èµ‹å€¼  ---> initialé˜¶æ®µï¼šç»™ç±»å˜é‡æ˜¾å¼èµ‹å€¼å³é™æ€ä»£ç å—èµ‹å€¼
      å®ä¾‹å˜é‡ï¼šéšç€å¯¹è±¡çš„åˆ›å»ºï¼Œä¼šåœ¨å †ç©ºé—´ä¸­åˆ†é…å®ä¾‹å˜é‡ç©ºé—´ï¼Œå¹¶è¿›è¡Œé»˜è®¤èµ‹å€¼
    â‘¡ å±€éƒ¨å˜é‡ï¼šåœ¨ä½¿ç”¨å‰ï¼Œå¿…é¡»è¦è¿›è¡Œæ˜¾å¼èµ‹å€¼çš„ï¼å¦åˆ™ï¼Œç¼–è¯‘ä¸é€šè¿‡
    */
    public void test5Temp(){
        int num;
        //System.out.println(num);//é”™è¯¯ä¿¡æ¯ï¼šå˜é‡numæœªè¿›è¡Œåˆå§‹åŒ–
    }
```

***è¿™æ ·çš„ä»£ç æ˜¯é”™è¯¯çš„ï¼Œæ²¡æœ‰èµ‹å€¼ä¸èƒ½å¤Ÿä½¿ç”¨***ã€‚

### è¡¥å……è¯´æ˜

â— åœ¨æ ˆå¸§ä¸­ï¼Œä¸æ€§èƒ½è°ƒä¼˜å…³ç³»æœ€ä¸ºå¯†åˆ‡çš„éƒ¨åˆ†å°±æ˜¯å‰é¢æåˆ°çš„å±€éƒ¨å˜é‡è¡¨ã€‚åœ¨æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œè™šæ‹Ÿæœºä½¿ç”¨å±€éƒ¨å˜é‡è¡¨å®Œæˆæ–¹æ³•çš„ä¼ é€’ã€‚  
â— **å±€éƒ¨å˜é‡è¡¨ä¸­çš„å˜é‡ä¹Ÿæ˜¯é‡è¦çš„åƒåœ¾å›æ”¶æ ¹èŠ‚ç‚¹ï¼Œåªè¦è¢«å±€éƒ¨å˜é‡è¡¨ä¸­ç›´æ¥æˆ–é—´æ¥å¼•ç”¨çš„å¯¹è±¡éƒ½ä¸ä¼šè¢«å›æ”¶**ã€‚  

---

## 4 æ“ä½œæ•°æ ˆ

* æ¯ä¸€ä¸ªç‹¬ç«‹çš„æ ˆå¸§ä¸­é™¤äº†åŒ…å«å±€éƒ¨å˜é‡è¡¨ä»¥å¤–ï¼Œè¿˜åŒ…å«ä¸€ä¸ªåè¿›å…ˆå‡º(Last-In-First-out )çš„æ“ä½œæ•°æ ˆï¼Œä¹Ÿå¯ä»¥ç§°ä¹‹ä¸ºè¡¨è¾¾å¼æ ˆ(Expression Stack) ã€‚
* **æ“ä½œæ•°æ ˆï¼Œåœ¨æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ ¹æ®å­—èŠ‚ç æŒ‡ä»¤ï¼Œå¾€æ ˆä¸­å†™å…¥æ•°æ®æˆ–æå–æ•°æ®ï¼Œå³å…¥æ ˆ(push) /å‡ºæ ˆ(pop)**ã€‚
  * â¢ æŸäº›å­—èŠ‚ç æŒ‡ä»¤å°†å€¼å‹å…¥æ“ä½œæ•°æ ˆï¼Œå…¶ä½™çš„å­—èŠ‚ç æŒ‡ä»¤å°†æ“ä½œæ•°å–å‡ºæ ˆã€‚ä½¿ç”¨å®ƒä»¬åå†æŠŠç»“æœå‹å…¥æ ˆã€‚
  * â¢ æ¯”å¦‚:æ‰§è¡Œå¤åˆ¶ã€äº¤æ¢ã€æ±‚å’Œç­‰æ“ä½œ
* æ“ä½œæ•°æ ˆï¼Œ**ä¸»è¦ç”¨äºä¿å­˜è®¡ç®—è¿‡ç¨‹çš„ä¸­é—´ç»“æœï¼ŒåŒæ—¶ä½œä¸ºè®¡ç®—è¿‡ç¨‹ä¸­å˜é‡ä¸´æ—¶çš„å­˜å‚¨ç©ºé—´**ã€‚
* æ“ä½œæ•°æ ˆå°±æ˜¯JVMæ‰§è¡Œå¼•æ“çš„ä¸€ä¸ªå·¥ä½œåŒºï¼Œå½“ä¸€ä¸ªæ–¹æ³•åˆšå¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸€ä¸ªæ–°çš„æ ˆå¸§ä¹Ÿä¼šéšä¹‹è¢«åˆ›å»ºå‡ºæ¥ï¼Œ**è¿™ä¸ªæ–¹æ³•çš„æ“ä½œæ•°æ ˆæ˜¯ç©ºçš„**ã€‚
* æ¯ä¸€ä¸ªæ“ä½œæ•°æ ˆéƒ½ä¼šæ‹¥æœ‰ä¸€ä¸ªæ˜ç¡®çš„æ ˆæ·±åº¦ç”¨äºå­˜å‚¨æ•°å€¼ï¼Œå…¶æ‰€éœ€çš„æœ€å¤§æ·±åº¦**åœ¨ç¼–è¯‘æœŸå°±å®šä¹‰å¥½äº†**ï¼Œä¿å­˜åœ¨æ–¹æ³•çš„Codeå±æ€§ä¸­ï¼ˆæ¯”å¦‚`stack=2`ï¼‰ï¼Œä¸ºmax_stackçš„å€¼ã€‚
* æ ˆä¸­çš„ä»»ä½•ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯å¯ä»¥ä»»æ„çš„Javaæ•°æ®ç±»å‹ã€‚
  * â¢ 32bitçš„ç±»å‹å ç”¨ä¸€ä¸ªæ ˆå•ä½æ·±åº¦
  * â¢ 64bitçš„ç±»å‹å ç”¨ä¸¤ä¸ªæ ˆå•ä½æ·±åº¦
* æ“ä½œæ•°æ ˆ**å¹¶éé‡‡ç”¨è®¿é—®ç´¢å¼•çš„æ–¹å¼æ¥è¿›è¡Œæ•°æ®è®¿é—®**çš„ï¼Œè€Œæ˜¯åªèƒ½é€šè¿‡æ ‡å‡†çš„å…¥æ ˆ(push) å’Œå‡ºæ ˆ(pop) æ“ä½œæ¥å®Œæˆä¸€æ¬¡æ•°æ®è®¿é—®ã€‚
* **å¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•å¸¦æœ‰è¿”å›å€¼çš„è¯ï¼Œå…¶è¿”å›å€¼å°†ä¼šè¢«å‹å…¥å½“å‰æ ˆå¸§çš„æ“ä½œæ•°æ ˆä¸­**ï¼Œå¹¶æ›´æ–°PCå¯„å­˜å™¨ä¸­ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ã€‚
* æ“ä½œæ•°æ ˆä¸­å…ƒç´ çš„æ•°æ®ç±»å‹å¿…é¡»ä¸å­—èŠ‚ç æŒ‡ä»¤çš„åºåˆ—ä¸¥æ ¼åŒ¹é…ï¼Œè¿™ç”±ç¼–è¯‘å™¨åœ¨ç¼–è¯‘å™¨æœŸé—´è¿›è¡ŒéªŒè¯ï¼ŒåŒæ—¶åœ¨ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„ç±»æ£€éªŒé˜¶æ®µçš„æ•°æ®æµåˆ†æé˜¶æ®µè¦å†æ¬¡éªŒè¯ã€‚
* å¦å¤–ï¼Œæˆ‘ä»¬è¯´Javaè™šæ‹Ÿæœºçš„**è§£é‡Šå¼•æ“æ˜¯åŸºäºæ ˆçš„æ‰§è¡Œå¼•æ“**ï¼Œå…¶ä¸­çš„æ ˆæŒ‡çš„å°±æ˜¯æ“ä½œæ•°æ ˆã€‚

ä»£ç è¿½è¸ªï¼š

```java
public void testAddOperation() {
        //byteã€shortã€charã€booleanï¼šéƒ½ä»¥intå‹æ¥ä¿å­˜
        byte i = 15;
        int j = 8;
        int k = i + j;

       // int m = 800;

    }
```

`javap -v ç±»å.class`

```java
  public void testAddOperation();
    descriptor: ()V
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=2, locals=4, args_size=1
         0: bipush        15
         2: istore_1
         3: bipush        8
         5: istore_2
         6: iload_1
         7: iload_2
         8: iadd
         9: istore_3
        10: return
      LineNumberTable:
        line 10: 0
        line 11: 3
        line 12: 6
        line 16: 10
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      11     0  this   Lcom/atguigu/java1/OperandStackTest;
            3       8     1     i   B
            6       5     2     j   I
           10       1     3     k   I
```

åˆ†æï¼ˆæ˜¯æˆ‘æ¨æµ‹ï¼Œä¸çŸ¥å¯¹å¦ï¼Œå›å¤´å†çœ‹ï¼‰ï¼š

å­—èŠ‚ç æŒ‡ä»¤ | æ“ä½œæ•°æ ˆï¼ˆåŠ¨ä½œï¼Œæ ˆå…ƒç´  æ ˆåº• --> æ ˆé¡¶ï¼‰ | å±€éƒ¨å˜é‡è¡¨ï¼ˆSlot0123ï¼‰
--|--|--
 0: bipush        15 | å…¥æ ˆï¼Œ15 | this,
 2: istore_1 | å‡ºæ ˆï¼Œç©º | this, 15
 3: bipush        8 | å…¥æ ˆï¼Œ8 | this, 15
 5: istore_2 | å‡ºæ ˆï¼Œç©º | this, 15, 8
 6: iload_1 | å…¥æ ˆï¼Œ15 | this, 15, 8
 7: iload_2 | å…¥æ ˆï¼Œ15, 8 | this, 15, 8
 8: iadd | å‡ºæ ˆ(8)ï¼Œå‡ºæ ˆ(15)ï¼Œå…¥æ ˆ(23) ï¼Œ23| this, 15, 8
 9: istore_3 | å‡ºæ ˆï¼Œç©º | this, 15, 8, 23
10: return | æ— åŠ¨ä½œï¼Œç©º | this, 15, 8, 23  

---

## 5 ä»£ç è¿½è¸ª

<iframe width="945" height="511" src="https://www.youtube.com/embed/LwvJVxoExqU?list=PLtGk8Nqe2ZcK0xUtbQjHeX2gqgoOdKJnX" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

---

### `i++` å’Œ `++i` çš„åŒºåˆ«

```java
/*
  ç¨‹åºå‘˜é¢è¯•è¿‡ç¨‹ä¸­ï¼Œ å¸¸è§çš„i++å’Œ++i çš„åŒºåˆ«ï¼Œæ”¾åˆ°å­—èŠ‚ç ç¯‡ç« æ—¶å†ä»‹ç»ã€‚

    */
  public void add(){
      //ç¬¬1ç±»é—®é¢˜ï¼š
      int i1 = 10;
      i1++;

      int i2 = 10;
      ++i2;

      //ç¬¬2ç±»é—®é¢˜ï¼š
      int i3 = 10;
      int i4 = i3++;

      int i5 = 10;
      int i6 = ++i5;

      //ç¬¬3ç±»é—®é¢˜ï¼š
      int i7 = 10;
      i7 = i7++;

      int i8 = 10;
      i8 = ++i8;

      //ç¬¬4ç±»é—®é¢˜ï¼š
      int i9 = 10;
      int i10 = i9++ + ++i9;
      //System.out.println(i10);//22
  }
```

å°è¯•é€šè¿‡åˆ†æå­—èŠ‚ç çš„æ–¹å¼å»ç†è§£ï¼š

```java
public void add();
  descriptor: ()V
  flags: (0x0001) ACC_PUBLIC
  Code:
    stack=2, locals=11, args_size=1
       0: bipush        10
       2: istore_1
       3: iinc          1, 1
       6: bipush        10
       8: istore_2
       9: iinc          2, 1
      12: bipush        10
      14: istore_3
      15: iload_3
      16: iinc          3, 1
      19: istore        4
      21: bipush        10
      23: istore        5
      25: iinc          5, 1
      28: iload         5
      30: istore        6
      32: bipush        10
      34: istore        7
      36: iload         7
      38: iinc          7, 1
      41: istore        7
      43: bipush        10
      45: istore        8
      47: iinc          8, 1
      50: iload         8
      52: istore        8
      54: bipush        10
      56: istore        9
      58: iload         9
      60: iinc          9, 1
      63: iinc          9, 1
      66: iload         9
      68: iadd
      69: istore        10
      71: return
```

ç¨‹åºå‘˜é¢è¯•è¿‡ç¨‹ä¸­ï¼Œå¸¸è§çš„ `i++` å’Œ `++i` çš„åŒºåˆ«, æ”¾åˆ°å­—èŠ‚ç ç¯‡ç« æ—¶å†ä»‹ç»ã€‚

---

## 6 æ ˆé¡¶ç¼“å­˜æŠ€æœ¯

å‰é¢æè¿‡ï¼ŒåŸºäºæ ˆå¼æ¶æ„çš„è™›æ‹Ÿæœºæ‰€ä½¿ç”¨çš„é›¶åœ°å€æŒ‡ä»¤æ›´åŠ ç´§å‡‘ï¼Œä½†å®Œæˆä¸€é¡¹æ“ä½œçš„æ—¶å€™å¿…ç„¶éœ€è¦ä½¿ç”¨æ›´å¤šçš„å…¥æ ˆå’Œå‡ºæ ˆæŒ‡ä»¤ï¼Œè¿™åŒæ—¶ä¹Ÿå°±æ„å‘³ç€å°†éœ€è¦æ›´å¤šçš„æŒ‡ä»¤åˆ†æ´¾(instruction dispatch)æ¬¡æ•°å’Œå†…å­˜è¯»/å†™æ¬¡æ•°ã€‚

ç”±äºæ“ä½œæ•°æ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ï¼Œå› æ­¤é¢‘ç¹åœ°æ‰§è¡Œå†…å­˜è¯»/å†™æ“ä½œå¿…ç„¶ä¼šå½±å“æ‰§è¡Œé€Ÿåº¦ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒHotSpot JVMçš„è®¾è®¡è€…ä»¬æå‡ºäº†æ ˆé¡¶ç¼“å­˜(ToSï¼ŒTop-of-Stack Cashing)æŠ€æœ¯ï¼Œ**å°†æ ˆé¡¶å…ƒç´ å…¨éƒ¨ç¼“å­˜åœ¨ç‰©ç†CPUçš„å¯„å­˜å™¨ä¸­ï¼Œä»¥æ­¤é™ä½å¯¹å†…å­˜çš„è¯»/å†™æ¬¡æ•°ï¼Œæå‡æ‰§è¡Œå¼•æ“çš„æ‰§è¡Œæ•ˆç‡**ã€‚

---

## 7 åŠ¨æ€é“¾æ¥

![å¸§æ•°æ®åŒº](æ ˆå¸§1.png)

åŠ¨æ€é“¾æ¥(æˆ–æŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± çš„æ–¹æ³•å¼•ç”¨)

æ¯ä¸€ä¸ªæ ˆå¸§å†…éƒ¨éƒ½åŒ…å«ä¸€ä¸ªæŒ‡å‘ *è¿è¡Œæ—¶å¸¸é‡æ± * ä¸­ **è¯¥æ ˆå¸§æ‰€å±æ–¹æ³•çš„å¼•ç”¨**ã€‚åŒ…å«è¿™ä¸ªå¼•ç”¨çš„ç›®çš„å°±æ˜¯ä¸ºäº†æ”¯æŒå½“å‰æ–¹æ³•çš„ä»£ç èƒ½å¤Ÿå®ç°**åŠ¨æ€é“¾æ¥(Dynamic Linking)** ã€‚æ¯”å¦‚: invokedynamicæŒ‡ä»¤

åœ¨Javaæºæ–‡ä»¶è¢«ç¼–è¯‘åˆ°å­—èŠ‚ç æ–‡ä»¶ä¸­æ—¶ï¼Œæ‰€æœ‰çš„å˜é‡å’Œæ–¹æ³•å¼•ç”¨éƒ½ä½œä¸ºç¬¦å·å¼•ç”¨(Symbolic Reference) ä¿å­˜åœ¨ classæ–‡ä»¶çš„å¸¸é‡æ± ï¼ˆè¿è¡Œèµ·æ¥ä»¥åä¿å­˜åˆ°æ–¹æ³•åŒºå°±æ˜¯è¿è¡Œæ—¶å¸¸é‡æ± ï¼‰é‡Œã€‚æ¯”å¦‚:æè¿°ä¸€ä¸ªæ–¹æ³•è°ƒç”¨äº†å¦å¤–çš„å…¶ä»–æ–¹æ³•æ—¶ï¼Œå°±æ˜¯é€šè¿‡å¸¸é‡æ± ä¸­æŒ‡å‘æ–¹æ³•çš„ç¬¦å·å¼•ç”¨æ¥è¡¨ç¤ºçš„ï¼Œé‚£ä¹ˆ**åŠ¨æ€é“¾æ¥çš„ä½œç”¨å°±æ˜¯ä¸ºäº†å°†è¿™äº›ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºè°ƒç”¨æ–¹æ³•çš„ç›´æ¥å¼•ç”¨**ã€‚

![åŠ¨æ€é“¾æ¥](åŠ¨æ€é“¾æ¥1.png)

**ä¸ºä»€ä¹ˆéœ€è¦å¸¸é‡æ± å‘¢**ï¼Ÿ

å¸¸é‡æ± çš„ä½œç”¨ï¼Œå°±æ˜¯ä¸ºäº†æä¾›ä¸€äº›ç¬¦å·å’Œå¸¸é‡ï¼Œä¾¿äºæŒ‡ä»¤çš„è¯†åˆ«ã€‚

---

## 8 æ–¹æ³•çš„è°ƒç”¨:è§£æä¸åˆ†æ´¾

åŸç†ã€è¿‡ç¨‹

### æ–¹æ³•çš„ç»‘å®šæœºåˆ¶

åœ¨JVMä¸­ï¼Œå°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºè°ƒç”¨æ–¹æ³•çš„ç›´æ¥å¼•ç”¨ä¸æ–¹æ³•çš„ç»‘å®šæœºåˆ¶ç›¸å…³ã€‚

â— **é™æ€é“¾æ¥**:
å½“ä¸€ä¸ªå­—èŠ‚ç æ–‡ä»¶è¢«è£…è½½è¿›JVMå†…éƒ¨æ—¶ï¼Œå¦‚æœè¢«è°ƒç”¨çš„**ç›®æ ‡æ–¹æ³•åœ¨ç¼–è¯‘æœŸå¯çŸ¥**,ä¸”è¿è¡ŒæœŸä¿æŒä¸å˜æ—¶ã€‚è¿™ç§æƒ…å†µä¸‹å°†è°ƒç”¨æ–¹æ³•çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºé™æ€é“¾æ¥ã€‚

â— **åŠ¨æ€é“¾æ¥**:
å¦‚æœ**è¢«è°ƒç”¨çš„æ–¹æ³•åœ¨ç¼–è¯‘æœŸæ— æ³•è¢«ç¡®å®šä¸‹æ¥**ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªèƒ½å¤Ÿåœ¨ç¨‹åºè¿è¡ŒæœŸå°†è°ƒç”¨æ–¹æ³•çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼Œç”±äºè¿™ç§å¼•ç”¨è½¬æ¢è¿‡ç¨‹å…·å¤‡åŠ¨æ€æ€§ï¼Œå› æ­¤ä¹Ÿå°±è¢«ç§°ä¹‹ä¸ºåŠ¨æ€é“¾æ¥ã€‚

å¯¹åº”çš„æ–¹æ³•çš„ç»‘å®šæœºåˆ¶ä¸º:æ—©æœŸç»‘å®š(Early Binding)å’Œæ™šæœŸç»‘å®š(Late Binding) ã€‚**ç»‘å®šæ˜¯ä¸€ä¸ªå­—æ®µã€æ–¹æ³•æˆ–è€…ç±»åœ¨ç¬¦å·å¼•ç”¨è¢«æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ï¼Œè¿™ä»…ä»…å‘ç”Ÿä¸€æ¬¡**ã€‚

â— **æ—©æœŸç»‘å®š**:
æ—©æœŸç»‘å®šå°±æ˜¯æŒ‡è¢«è°ƒç”¨çš„**ç›®æ ‡æ–¹æ³•å¦‚æœåœ¨ç¼–è¯‘æœŸå¯çŸ¥ï¼Œä¸”è¿è¡ŒæœŸä¿æŒä¸å˜æ—¶**,å³å¯å°†è¿™ä¸ªæ–¹æ³•ä¸æ‰€å±çš„ç±»å‹è¿›è¡Œç»‘å®šï¼Œè¿™æ ·ä¸€æ¥ï¼Œç”±äºæ˜ç¡®äº†è¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•ç©¶ç«Ÿæ˜¯å“ªä¸€ä¸ªï¼Œå› æ­¤ä¹Ÿå°±å¯ä»¥ä½¿ç”¨é™æ€é“¾æ¥çš„æ–¹å¼å°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ã€‚

â— **æ™šæœŸç»‘å®š**:
å¦‚æœ**è¢«è°ƒç”¨çš„æ–¹æ³•åœ¨ç¼–è¯‘æœŸæ— æ³•è¢«ç¡®å®šä¸‹æ¥ï¼Œåªèƒ½å¤Ÿåœ¨ç¨‹åºè¿è¡ŒæœŸæ ¹æ®å®é™…çš„ç±»å‹ç»‘å®šç›¸å…³çš„æ–¹æ³•**ï¼Œè¿™ç§ç»‘å®šæ–¹å¼ä¹Ÿå°±è¢«ç§°ä¹‹ä¸ºæ™šæœŸç»‘å®šã€‚

```java
package com.atguigu.java2;

/**
 * è¯´æ˜æ—©æœŸç»‘å®šå’Œæ™šæœŸç»‘å®šçš„ä¾‹å­
 * @author shkstart
 * @create 2020 ä¸Šåˆ 11:59
 */
class Animal{

    public void eat(){
        System.out.println("åŠ¨ç‰©è¿›é£Ÿ");
    }
}
interface Huntable{
    void hunt();
}
class Dog extends Animal implements Huntable{
    @Override
    public void eat() {
        System.out.println("ç‹—åƒéª¨å¤´");
    }

    @Override
    public void hunt() {
        System.out.println("æ•é£Ÿè€—å­ï¼Œå¤šç®¡é—²äº‹");
    }
}

class Cat extends Animal implements Huntable{

    public Cat(){
        super();//è¡¨ç°ä¸ºï¼šæ—©æœŸç»‘å®š
    }

    public Cat(String name){
        this();//è¡¨ç°ä¸ºï¼šæ—©æœŸç»‘å®š
    }

    @Override
    public void eat() {
        super.eat();//è¡¨ç°ä¸ºï¼šæ—©æœŸç»‘å®š
        System.out.println("çŒ«åƒé±¼");
    }

    @Override
    public void hunt() {
        System.out.println("æ•é£Ÿè€—å­ï¼Œå¤©ç»åœ°ä¹‰");
    }
}
public class AnimalTest {
    public void showAnimal(Animal animal){
        animal.eat();//è¡¨ç°ä¸ºï¼šæ™šæœŸç»‘å®š
    }
    public void showHunt(Huntable h){
        h.hunt();//è¡¨ç°ä¸ºï¼šæ™šæœŸç»‘å®š
    }
}
```

éšç€é«˜çº§è¯­è¨€çš„æ¨ªç©ºå‡ºä¸–ï¼Œç±»ä¼¼äºJavaä¸€æ ·çš„åŸºäºé¢å‘å¯¹è±¡çš„ç¼–ç¨‹è¯­è¨€å¦‚ä»Šè¶Šæ¥è¶Šå¤šï¼Œå°½ç®¡è¿™ç±»ç¼–ç¨‹è¯­è¨€åœ¨è¯­æ³•é£æ ¼ä¸Šå­˜åœ¨ä¸€å®šçš„å·®åˆ«ï¼Œä½†æ˜¯å®ƒä»¬å½¼æ­¤ä¹‹é—´å§‹ç»ˆä¿æŒç€ä¸€ä¸ªå…±æ€§ï¼Œé‚£å°±æ˜¯éƒ½æ”¯æŒå°è£…ã€ç»§æ‰¿å’Œå¤šæ€ç­‰é¢å‘å¯¹è±¡ç‰¹æ€§ï¼Œæ—¢ç„¶**è¿™ä¸€ç±»çš„ç¼–ç¨‹è¯­è¨€å…·å¤‡å¤šæ€ç‰¹æ€§ï¼Œé‚£ä¹ˆè‡ªç„¶ä¹Ÿå°±å…·å¤‡æ—©æœŸç»‘å®šå’Œæ™šæœŸç»‘å®šä¸¤ç§ç»‘å®šæ–¹å¼**ã€‚

Javaä¸­ä»»ä½•ä¸€ä¸ªæ™®é€šçš„æ–¹æ³•å…¶å®éƒ½å…·å¤‡è™šå‡½æ•°çš„ç‰¹å¾ï¼Œå®ƒä»¬ç›¸å½“äºC++è¯­è¨€ä¸­çš„è™šå‡½æ•°(C++ä¸­åˆ™éœ€è¦ä½¿ç”¨å…³é”®å­— `virtual` æ¥æ˜¾å¼å®šä¹‰)ã€‚å¦‚æœåœ¨Javaç¨‹åºä¸­ä¸å¸Œæœ›æŸä¸ªæ–¹æ³•æ‹¥æœ‰è™šå‡½æ•°çš„ç‰¹å¾æ—¶ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å…³é”®å­— `final` æ¥æ ‡è®°è¿™ä¸ªæ–¹æ³•ã€‚

### è™šæ–¹æ³•ä¸éè™šæ–¹æ³•

**éè™šæ–¹æ³•**:

â— å¦‚æœæ–¹æ³•åœ¨ç¼–è¯‘æœŸå°±ç¡®å®šäº†å…·ä½“çš„è°ƒç”¨ç‰ˆæœ¨ï¼Œè¿™ä¸ªç‰ˆæœ¨åœ¨è¿è¡Œæ—¶æ˜¯ä¸å¯å˜çš„ã€‚è¿™æ ·çš„æ–¹æ³•ç§°ä¸º**éè™šæ–¹æ³•**ã€‚  
â— **é™æ€æ–¹æ³•ã€ç§æœ‰æ–¹æ³•ã€finalæ–¹æ³•ã€å®ä¾‹æ„é€ å™¨ã€çˆ¶ç±»æ–¹æ³•éƒ½æ˜¯éè™šæ–¹æ³•**ã€‚  
â— å…¶ä»–æ–¹æ³•ç§°ä¸ºè™šæ–¹æ³•ã€‚  

å­ç±»å¯¹è±¡çš„å¤šæ€æ€§çš„ä½¿ç”¨å‰æ: â‘  ç±»çš„ç»§æ‰¿å…³ç³» â‘¡ æ–¹æ³•çš„é‡å†™.

### 4ç§æ–¹æ³•è°ƒç”¨æŒ‡ä»¤åŒºåˆ†éè™šæ–¹æ³•ä¸è™šæ–¹æ³•

è™šæ‹Ÿæœºä¸­æä¾›äº†ä»¥ä¸‹å‡ æ¡æ–¹æ³•è°ƒç”¨æŒ‡ä»¤:

* æ™®é€šè°ƒç”¨æŒ‡ä»¤:
  1. **`invokestatic`: è°ƒç”¨é™æ€æ–¹æ³•ï¼Œè§£æé˜¶æ®µç¡®å®šå”¯ä¸€æ–¹æ³•ç‰ˆæœ¬**
  2. **`invokespecial`: è°ƒç”¨\<init>æ–¹æ³•ã€ ç§æœ‰åŠçˆ¶ç±»æ–¹æ³•ï¼Œè§£æé˜¶æ®µç¡®å®šå”¯ä¸€æ–¹æ³•ç‰ˆæœ¬**
  3. `invokevirtual`: è°ƒç”¨æ‰€æœ‰è™šæ–¹æ³•
  4. `invokeinterface`: è°ƒç”¨æ¥å£æ–¹æ³•
* åŠ¨æ€è°ƒç”¨æŒ‡ä»¤:
  1. `invokedynamic`: åŠ¨æ€è§£æå‡ºéœ€è¦è°ƒç”¨çš„æ–¹æ³•ï¼Œç„¶åæ‰§è¡Œ

å‰å››æ¡æŒ‡ä»¤å›ºåŒ–åœ¨è™›æ‹Ÿæœºå†…éƒ¨ï¼Œæ–¹æ³•çš„è°ƒç”¨æ‰§è¡Œä¸å¯äººä¸ºå¹²é¢„ï¼Œè€Œ `invokedynamic` æŒ‡ä»¤åˆ™æ”¯æŒç”±ç”¨æˆ·ç¡®å®šæ–¹æ³•ç‰ˆæœ¬ã€‚å…¶ä¸­ **`invokestatic` æŒ‡ä»¤å’Œ `invokespecial` æŒ‡ä»¤è°ƒç”¨çš„æ–¹æ³•ç§°ä¸ºéè™›æ–¹æ³•ï¼Œå…¶ä½™çš„( `final` ä¿®é¥°çš„é™¤å¤–)ç§°ä¸ºè™šæ–¹æ³•**ã€‚

```java
package com.atguigu.java2;

/**
 * è§£æè°ƒç”¨ä¸­éè™šæ–¹æ³•ã€è™šæ–¹æ³•çš„æµ‹è¯•
 *
 * invokestaticæŒ‡ä»¤å’ŒinvokespecialæŒ‡ä»¤è°ƒç”¨çš„æ–¹æ³•ç§°ä¸ºéè™šæ–¹æ³•
 * @author shkstart
 * @create 2020 ä¸‹åˆ 12:07
 */
class Father {
    public Father() {
        System.out.println("fatherçš„æ„é€ å™¨");
    }

    public static void showStatic(String str) {
        System.out.println("father " + str);
    }

    public final void showFinal() {
        System.out.println("father show final");
    }

    public void showCommon() {
        System.out.println("father æ™®é€šæ–¹æ³•");
    }
}

public class Son extends Father {
    public Son() {
        //invokespecial
        super();
    }
    public Son(int age) {
        //invokespecial
        this();
    }
    //ä¸æ˜¯é‡å†™çš„çˆ¶ç±»çš„é™æ€æ–¹æ³•ï¼Œå› ä¸ºé™æ€æ–¹æ³•ä¸èƒ½è¢«é‡å†™ï¼
    public static void showStatic(String str) {
        System.out.println("son " + str);
    }
    private void showPrivate(String str) {
        System.out.println("son private" + str);
    }

    public void show() {
        //invokestatic
        showStatic("atguigu.com");
        //invokestatic
        super.showStatic("good!");
        //invokespecial
        showPrivate("hello!");
        //invokespecial
        super.showCommon();

        //invokevirtual
        showFinal();//å› ä¸ºæ­¤æ–¹æ³•å£°æ˜æœ‰finalï¼Œä¸èƒ½è¢«å­ç±»é‡å†™ï¼Œæ‰€ä»¥ä¹Ÿè®¤ä¸ºæ­¤æ–¹æ³•æ˜¯éè™šæ–¹æ³•ã€‚
        //è™šæ–¹æ³•å¦‚ä¸‹ï¼š
        //invokevirtual
        showCommon();
        info();

        MethodInterface in = null;
        //invokeinterface
        in.methodA();
    }

    public void info(){

    }

    public void display(Father f){
        f.showCommon();
    }

    public static void main(String[] args) {
        Son so = new Son();
        so.show();
    }
}

interface MethodInterface{
    void methodA();
}
```

### å…³äº `invokedynamic` æŒ‡ä»¤

JVMå­—èŠ‚ç æŒ‡ä»¤é›†ä¸€ç›´æ¯”è¾ƒç¨³å®šï¼Œä¸€ç›´åˆ°Java7ä¸­æ‰å¢åŠ äº†ä¸€ä¸ª `invokedynamic` æŒ‡ä»¤ï¼Œè¿™æ˜¯**Javaä¸ºäº†å®ç°ã€ŒåŠ¨æ€ç±»å‹è¯­è¨€ã€æ”¯æŒè€Œåšçš„ä¸€ç§æ”¹è¿›**ã€‚

ä½†æ˜¯åœ¨Java7ä¸­å¹¶æ²¡æœ‰æä¾›ç›´æ¥ç”Ÿæˆ `invokedynamic` æŒ‡ä»¤çš„æ–¹æ³•ï¼Œéœ€è¦å€ŸåŠ© ASM è¿™ç§åº•å±‚å­—èŠ‚ç å·¥å…·æ¥äº§ç”Ÿ `invokedynamic` æŒ‡ä»¤ã€‚**ç›´åˆ° Java8 çš„ Lambda è¡¨è¾¾å¼çš„å‡ºç°ï¼Œ`invokedynamic` æŒ‡ä»¤çš„ç”Ÿæˆï¼Œåœ¨Javaä¸­æ‰æœ‰äº†ç›´æ¥çš„ç”Ÿæˆæ–¹å¼**ã€‚

Java7 ä¸­å¢åŠ çš„åŠ¨æ€è¯­è¨€ç±»å‹æ”¯æŒçš„æœ¬è´¨æ˜¯å¯¹ Javaè™šæ‹Ÿæœºè§„èŒƒçš„ä¿®æ”¹ï¼Œè€Œä¸æ˜¯å¯¹Javaè¯­è¨€è§„åˆ™çš„ä¿®æ”¹ï¼Œè¿™ä¸€å—ç›¸å¯¹æ¥è®²æ¯”è¾ƒå¤æ‚ï¼Œå¢åŠ äº†è™šæ‹Ÿæœºä¸­çš„æ–¹æ³•è°ƒç”¨ï¼Œæœ€ç›´æ¥çš„å—ç›Šè€…å°±æ˜¯è¿è¡Œåœ¨Javaå¹³å°çš„åŠ¨æ€è¯­è¨€çš„ç¼–è¯‘å™¨ã€‚

é™æ€ç±»å‹è¯­è¨€ä¸åŠ¨æ€ç±»å‹è¯­è¨€ï¼š

åŠ¨æ€ç±»å‹è¯­è¨€å’Œé™æ€ç±»å‹è¯­è¨€ä¸¤è€…çš„åŒºåˆ«å°±åœ¨äºå¯¹ç±»å‹çš„æ£€æŸ¥æ˜¯åœ¨ç¼–è¯‘æœŸè¿˜æ˜¯åœ¨è¿è¡ŒæœŸï¼Œæ»¡è¶³å‰è€…å°±æ˜¯é™æ€ç±»å‹è¯­è¨€ï¼Œåä¹‹æ˜¯åŠ¨æ€ç±»å‹è¯­è¨€ã€‚

è¯´çš„å†ç›´ç™½ä¸€ç‚¹å°±æ˜¯ï¼Œ**é™æ€ç±»å‹è¯­è¨€æ˜¯åˆ¤æ–­å˜é‡è‡ªèº«çš„ç±»å‹ä¿¡æ¯ï¼›åŠ¨æ€ç±»å‹è¯­è¨€æ˜¯åˆ¤æ–­å˜é‡å€¼çš„ç±»å‹ä¿¡æ¯ï¼Œå˜é‡æ²¡æœ‰ç±»å‹ä¿¡æ¯ï¼Œå˜é‡å€¼æ‰æœ‰ç±»å‹ä¿¡æ¯**ï¼Œè¿™æ˜¯åŠ¨æ€è¯­è¨€çš„ä¸€â€œä¸ªé‡è¦ç‰¹å¾ã€‚

æ¯”å¦‚ï¼Œ é™æ€ç±»å‹è¯­è¨€Javaï¼›åŠ¨æ€ç±»å‹è¯­è¨€JSï¼ŒPythonã€‚  

```PLAIN
Java: String info = "atguigu"; //info = atguigu;  
JS: var name = "shkstart"; var name = 10 ;  
Python: info = 130.5  
```

```java
package com.atguigu.java2;

/**
 * ä½“ä¼šinvokedynamicæŒ‡ä»¤
 * @author shkstart
 * @create 2020 ä¸‹åˆ 3:09
 */
@FunctionalInterface
interface Func {
    public boolean func(String str);
}

public class Lambda {
    public void lambda(Func func) {
        return;
    }

    public static void main(String[] args) {
        Lambda lambda = new Lambda();

        Func func = s -> {
            return true;
        };

        lambda.lambda(func);

        lambda.lambda(s -> {
            return true;
        });
    }
}
```

mainæ–¹æ³•å¯¹åº”å­—èŠ‚ç æŒ‡ä»¤å¦‚ä¸‹ï¼š

```java
 0 new #2 <com/atguigu/java2/Lambda>
 3 dup
 4 invokespecial #3 <com/atguigu/java2/Lambda.<init>>
 7 astore_1
 8 invokedynamic #4 <func, BootstrapMethods #0>
13 astore_2
14 aload_1
15 aload_2
16 invokevirtual #5 <com/atguigu/java2/Lambda.lambda>
19 aload_1
20 invokedynamic #6 <func, BootstrapMethods #1>
25 invokevirtual #5 <com/atguigu/java2/Lambda.lambda>
28 return
```

### æ–¹æ³•é‡å†™çš„æœ¬è´¨

Javaè¯­è¨€ä¸­æ–¹æ³•é‡å†™çš„æœ¬è´¨:

1. æ‰¾åˆ°æ“ä½œæ•°æ ˆé¡¹çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ‰€æ‰§è¡Œçš„å¯¹è±¡çš„å®é™…ç±»å‹ï¼Œè®°ä½œ `C`.
2. å¦‚æœåœ¨ç±»å‹ `C` ä¸­æ‰¾åˆ°ä¸å¸¸é‡ä¸­çš„æè¿°ç¬¦åˆç®€å•åç§°éƒ½ç›¸ç¬¦çš„æ–¹æ³•ï¼Œåˆ™è¿›è¡Œè®¿é—®æƒé™æ ¡éªŒï¼Œå¦‚æœé€šè¿‡åˆ™è¿”å›è¿™ä¸ªæ–¹æ³•çš„ç›´æ¥å¼•ç”¨ï¼ŒæŸ¥æ‰¾è¿‡ç¨‹ç»“æŸï¼›å¦‚æœä¸é€šè¿‡ï¼Œåˆ™è¿”å› `java.lang.IllegalAccessError` å¼‚å¸¸ã€‚
3. å¦åˆ™ï¼ŒæŒ‰ç…§ç»§æ‰¿å…³ç³»ä»ä¸‹å¾€ä¸Šä¾æ¬¡å¯¹ `C` çš„å„ä¸ªçˆ¶ç±»è¿›è¡Œç¬¬2æ­¥çš„æœç´¢å’ŒéªŒè¯è¿‡ç¨‹ã€‚
4. å¦‚æœå§‹ç»ˆæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„æ–¹æ³•ï¼Œåˆ™æŠ›å‡º `java.lang.AbstractMethodError` å¼‚å¸¸ã€‚

**IllegalAccessErrorä»‹ç»**: ç¨‹åºè¯•å›¾è®¿é—®æˆ–ä¿®æ”¹ä¸€ä¸ªå±æ€§æˆ–è°ƒç”¨ä¸€ä¸ªæ–¹æ³•ï¼Œ è¿™ä¸ªå±æ€§æˆ–æ–¹æ³•ï¼Œä½ æ²¡æœ‰æƒé™è®¿é—®ã€‚ä¸€èˆ¬çš„ï¼Œè¿™ä¸ªä¼šå¼•èµ·ç¼–è¯‘å™¨å¼‚å¸¸ã€‚è¿™ä¸ªé”™è¯¯å¦‚æœå‘ç”Ÿåœ¨è¿è¡Œæ—¶ï¼Œå°±è¯´æ˜ä¸€ä¸ªç±»å‘ç”Ÿäº†ä¸å…¼å®¹çš„æ”¹å˜ã€‚

âš ï¸ï¼šMavençš„jaråŒ…ç®¡ç†å†²çªæ—¶å®¹æ˜“å‡ºç°è¿™ä¸ªé—®é¢˜ï¼Œä¸”ä¸æ˜“å‘ç°ã€‚

### è™šæ–¹æ³•è¡¨

ä»æ–¹æ³•é‡å†™çš„æœ¬è´¨å¯ä»¥çœ‹å‡ºæ¥ï¼Œé¢‘ç¹çš„æŸ¥æ‰¾æ•ˆç‡ä½ã€‚

â— åœ¨é¢å‘å¯¹è±¡çš„ç¼–ç¨‹ä¸­ï¼Œä¼šå¾ˆé¢‘ç¹çš„ä½¿ç”¨åˆ°åŠ¨æ€åˆ†æ´¾ï¼Œå¦‚æœåœ¨æ¯æ¬¡åŠ¨æ€åˆ†æ´¾çš„è¿‡ç¨‹ä¸­éƒ½è¦é‡æ–°åœ¨ç±»çš„æ–¹æ³•å…ƒæ•°æ®ä¸­æœç´¢åˆé€‚çš„ç›®æ ‡çš„è¯å°±å¯èƒ½å½±å“åˆ°æ‰§è¡Œæ•ˆç‡ã€‚å› æ­¤ï¼Œ**ä¸ºäº†æé«˜æ€§èƒ½**ï¼Œ**JVMé‡‡ç”¨åœ¨ç±»çš„æ–¹æ³•åŒºå»ºç«‹ä¸€ä¸ªè™šæ–¹æ³•è¡¨(virtual method table) (éè™šæ–¹æ³•ä¸ä¼šå‡ºç°åœ¨è¡¨ä¸­)æ¥å®ç°ã€‚ä½¿ç”¨ç´¢å¼•è¡¨æ¥ä»£æ›¿æŸ¥æ‰¾**ã€‚

â— æ¯ä¸ªç±»ä¸­éƒ½æœ‰ä¸€ä¸ªè™šæ–¹æ³•è¡¨ï¼Œè¡¨ä¸­å­˜æ”¾ç€å„ä¸ªæ–¹æ³•çš„å®é™…å…¥å£ã€‚

â— é‚£ä¹ˆè™šæ–¹æ³•è¡¨ä»€ä¹ˆæ—¶å€™è¢«åˆ›å»º?  
è™šæ–¹æ³•è¡¨ä¼šåœ¨ç±»åŠ è½½çš„é“¾æ¥é˜¶æ®µè¢«åˆ›å»ºå¹¶å¼€å§‹åˆå§‹åŒ–ï¼Œç±»çš„å˜é‡åˆå§‹å€¼å‡†å¤‡å®Œæˆä¹‹åï¼ŒJVMä¼šæŠŠè¯¥ç±»çš„æ–¹æ³•è¡¨ä¹Ÿåˆå§‹åŒ–å®Œæ¯•ã€‚

---

## 9 æ–¹æ³•è¿”å›åœ°å€

![æ ˆå¸§ä¸­çš„æ–¹æ³•è¿”å›åœ°å€](æ ˆå¸§1.png)

æ–¹æ³•è¿”å›åœ°å€(return address)ã€‚

â— å­˜æ”¾è°ƒç”¨è¯¥æ–¹æ³•çš„pcå¯„å­˜å™¨çš„å€¼ã€‚

ä¸€ä¸ªæ–¹æ³•çš„ç»“æŸï¼Œæœ‰ä¸¤ç§æ–¹å¼:

* â¢ æ­£å¸¸æ‰§è¡Œå®Œæˆ
* â¢ å‡ºç°æœªå¤„ç†çš„å¼‚å¸¸ï¼Œéæ­£å¸¸é€€å‡º
  
æ— è®ºé€šè¿‡å“ªç§æ–¹å¼é€€å‡ºï¼Œåœ¨æ–¹æ³•é€€å‡ºåéƒ½è¿”å›åˆ°è¯¥æ–¹æ³•è¢«è°ƒç”¨çš„ä½ç½®ã€‚æ–¹æ³•æ­£å¸¸é€€å‡ºæ—¶ï¼Œ**è°ƒç”¨è€…çš„pcè®¡æ•°å™¨çš„å€¼ä½œä¸ºè¿”å›åœ°å€ï¼Œå³è°ƒç”¨è¯¥æ–¹æ³•çš„æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€**ã€‚è€Œé€šè¿‡å¼‚å¸¸é€€å‡ºçš„ï¼Œè¿”å›åœ°å€æ˜¯è¦é€šè¿‡å¼‚å¸¸è¡¨æ¥ç¡®å®šï¼Œæ ˆå¸§ä¸­-èˆ¬ä¸ä¼šä¿å­˜è¿™éƒ¨åˆ†ä¿¡æ¯ã€‚

å½“ä¸€ä¸ªæ–¹æ³•å¼€å§‹æ‰§è¡Œåï¼Œåªæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥é€€å‡ºè¿™ä¸ªæ–¹æ³•:

1ã€æ‰§è¡Œå¼•æ“é‡åˆ°ä»»æ„ä¸€ä¸ªæ–¹æ³•è¿”å›çš„å­—èŠ‚ç æŒ‡ä»¤(return) ï¼Œä¼šæœ‰è¿”å›å€¼ä¼ é€’ç»™ä¸Šå±‚çš„æ–¹æ³•è°ƒç”¨è€…ï¼Œç®€ç§°**æ­£å¸¸å®Œæˆå‡ºå£**ï¼›

* â¢ ä¸€ä¸ªæ–¹æ³•åœ¨æ­£å¸¸è°ƒç”¨å®Œæˆä¹‹åç©¶ç«Ÿéœ€è¦ä½¿ç”¨å“ªä¸€ä¸ªè¿”å›æŒ‡ä»¤è¿˜éœ€è¦æ ¹æ®æ–¹æ³•è¿”å›å€¼çš„å®é™…æ•°æ®ç±»å‹è€Œå®šã€‚
* â¢ åœ¨å­—èŠ‚ç æŒ‡ä»¤ä¸­ï¼Œè¿”å›æŒ‡ä»¤åŒ…å« `ireturn` (å½“è¿”å›å€¼æ˜¯ `boolean`ã€ `byte`ã€`char`ã€ `short` å’Œ `int` ç±»å‹æ—¶ä½¿ç”¨)ã€`lreturn` ï¼ˆlongï¼‰ã€ `freturn` ï¼ˆfloatï¼‰ã€ `dreturn` ï¼ˆdoubleï¼‰ ä»¥åŠ [`areturn` ï¼ˆè¿”å›å¼•ç”¨ç±»å‹ï¼‰](https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5.areturn),å¦å¤–è¿˜æœ‰ä¸€ä¸ª `return` æŒ‡ä»¤ä¾›å£°æ˜ä¸º `void` çš„æ–¹æ³•ã€å®ä¾‹åˆå§‹åŒ–æ–¹æ³•ã€ç±»å’Œæ¥å£çš„åˆå§‹åŒ–æ–¹æ³•ä½¿ç”¨ã€‚

2ã€åœ¨æ–¹æ³•æ‰§è¡Œçš„è¿‡ç¨‹ä¸­é‡åˆ°äº†å¼‚å¸¸(Exception)ï¼Œå¹¶ä¸”è¿™ä¸ªå¼‚å¸¸æ²¡æœ‰åœ¨æ–¹æ³•å†…è¿›è¡Œå¤„ç†ï¼Œä¹Ÿå°±æ˜¯åªè¦åœ¨æœ¬æ–¹æ³•çš„å¼‚å¸¸è¡¨ä¸­æ²¡æœ‰æœç´¢åˆ°åŒ¹é…çš„å¼‚å¸¸å¤„ç†å™¨ï¼Œå°±ä¼šå¯¼è‡´æ–¹æ³•é€€å‡ºã€‚ç®€ç§°**å¼‚å¸¸å®Œæˆå‡ºå£**ã€‚

æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸æ—¶çš„å¼‚å¸¸å¤„ç†ï¼Œå­˜å‚¨åœ¨ä¸€ä¸ªå¼‚å¸¸å¤„ç†è¡¨ï¼Œæ–¹ä¾¿åœ¨å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™æ‰¾åˆ°å¤„ç†å¼‚å¸¸çš„ä»£ç ã€‚

Exception table:||||
--|--|--|--
from | to | target | type
4|16|19|any
19|21|19|any

æœ¬è´¨ä¸Šï¼Œæ–¹æ³•çš„é€€å‡ºå°±æ˜¯å½“å‰æ ˆå¸§å‡ºæ ˆçš„è¿‡ç¨‹ã€‚æ­¤æ—¶ï¼Œéœ€è¦æ¢å¤ä¸Šå±‚æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€å°†è¿”å›å€¼å‹å…¥è°ƒç”¨è€…æ ˆå¸§çš„æ“ä½œæ•°æ ˆã€è®¾ç½®PCå¯„å­˜å™¨å€¼ç­‰ï¼Œè®©è°ƒç”¨è€…æ–¹æ³•ç»§ç»­æ‰§è¡Œä¸‹å»ã€‚

**æ­£å¸¸å®Œæˆå‡ºå£å’Œå¼‚å¸¸å®Œæˆå‡ºå£çš„åŒºåˆ«åœ¨äº:é€šè¿‡å¼‚å¸¸å®Œæˆå‡ºå£é€€å‡ºçš„ä¸ä¼šç»™ä»–çš„ä¸Šå±‚è°ƒç”¨è€…äº§ç”Ÿä»»ä½•çš„è¿”å›å€¼**ã€‚

---

## 10 ä¸€äº›é™„åŠ ä¿¡æ¯

æ ˆå¸§ä¸­è¿˜å…è®¸æºå¸¦ä¸Javaè™›æ‹Ÿæœºå®ç°ç›¸å…³çš„ä¸€äº›é™„åŠ ä¿¡æ¯ã€‚ä¾‹å¦‚,å¯¹ç¨‹åºè°ƒè¯•æä¾›æ”¯æŒçš„ä¿¡æ¯ã€‚

---

## 11 è™šæ‹Ÿæœºæ ˆçš„ç›¸å…³é¢è¯•é¢˜

è¿™ä¸€ç« ä¸»è¦è®²äº†è™šæ‹Ÿæœºæ ˆçš„å†…éƒ¨ç»“æ„ï¼Œå…¶ä¸­æ ˆå¸§çš„ç»“æ„åŒ…å«å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€æ–¹æ³•è¿”å›åœ°å€ã€åŠ¨æ€é“¾æ¥å’Œä¸€äº›é™„åŠ ä¿¡æ¯ã€‚ä¹Ÿæåˆ°äº†æ–¹æ³•è°ƒç”¨å’Œä¸€äº›å­—èŠ‚ç æŒ‡ä»¤ã€‚

* â— ä¸¾ä¾‹æ ˆæº¢å‡ºçš„æƒ…å†µ? ï¼ˆ`StackOverflowError`ï¼‰
  * é€šè¿‡ `-Xss` è®¾ç½®æ ˆçš„å¤§å°ï¼š`OOM`(æ ˆå¤§å°åŠ¨æ€æ‰©å®¹å†…å­˜ä¸è¶³æ—¶å‡ºç°)
* â— è°ƒæ•´æ ˆå¤§å°ï¼Œå°±èƒ½ä¿è¯ä¸å‡ºç°æº¢å‡ºå—? ï¼ˆä¸èƒ½ï¼‰
* â— åˆ†é…çš„æ ˆå†…å­˜è¶Šå¤§è¶Šå¥½å—? ï¼ˆä¸æ˜¯ã€‚æ¯”å¦‚ç‰©ç†æœºå™¨å†…å­˜å®¹é‡æœ‰é™ï¼Œä¼šæŒ¤å å…¶ä»–è¿›ç¨‹çš„å†…å­˜ç©ºé—´ï¼‰
* â— åƒåœ¾å›æ”¶æ˜¯å¦ä¼šæ¶‰åŠåˆ°è™šæ‹Ÿæœºæ ˆ? ï¼ˆä¸ä¼šï¼‰
  è¿è¡Œæ—¶æ•°æ®åŒº|Error | GC
  --|--|--
  ç¨‹åºè®¡æ•°å™¨|âŒ|âŒ
  è™šæ‹Ÿæœºæ ˆ|âœ…|âŒ
  æœ¬åœ°æ–¹æ³•æ ˆ|âœ…|âŒ
  å †|âœ…|âœ…
  æ–¹æ³•åŒº|âœ…|âœ…
* â— æ–¹æ³•ä¸­å®šä¹‰çš„å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨? ï¼ˆå…·ä½“é—®é¢˜å…·ä½“åˆ†æï¼‰

```java
package com.atguigu.java3;

/**
 * é¢è¯•é¢˜ï¼š
 * æ–¹æ³•ä¸­å®šä¹‰çš„å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿå…·ä½“æƒ…å†µå…·ä½“åˆ†æ
 *
 *   ä½•ä¸ºçº¿ç¨‹å®‰å…¨ï¼Ÿ
 *      å¦‚æœåªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰å¯ä»¥æ“ä½œæ­¤æ•°æ®ï¼Œåˆ™å¿…æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
 *      å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹æ“ä½œæ­¤æ•°æ®ï¼Œåˆ™æ­¤æ•°æ®æ˜¯å…±äº«æ•°æ®ã€‚å¦‚æœä¸è€ƒè™‘åŒæ­¥æœºåˆ¶çš„è¯ï¼Œä¼šå­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚
 * @author shkstart
 * @create 2020 ä¸‹åˆ 7:48
 */
public class StringBuilderTest {

    int num = 10;

    //s1çš„å£°æ˜æ–¹å¼æ˜¯çº¿ç¨‹å®‰å…¨çš„
    public static void method1(){
        //StringBuilder:çº¿ç¨‹ä¸å®‰å…¨
        StringBuilder s1 = new StringBuilder();
        s1.append("a");
        s1.append("b");
        //...
    }
    //sBuilderçš„æ“ä½œè¿‡ç¨‹ï¼šæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„
    public static void method2(StringBuilder sBuilder){
        sBuilder.append("a");
        sBuilder.append("b");
        //...
    }
    //s1çš„æ“ä½œï¼šæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„
    public static StringBuilder method3(){
        StringBuilder s1 = new StringBuilder();
        s1.append("a");
        s1.append("b");
        return s1;
    }
    //s1çš„æ“ä½œï¼šæ˜¯çº¿ç¨‹å®‰å…¨çš„
    public static String method4(){
        StringBuilder s1 = new StringBuilder();
        s1.append("a");
        s1.append("b");
        return s1.toString();
    }

    public static void main(String[] args) {
        StringBuilder s = new StringBuilder();


        new Thread(() -> {
            s.append("a");
            s.append("b");
        }).start();

        method2(s);

    }

}
```

---

## æœ¬åœ°æ–¹æ³•æ ˆ(Native Method Stack)

![HotSpot JVM æœ¬åœ°æ–¹æ³•æ ˆ](æœ¬åœ°æ–¹æ³•æ ˆ1.png)

**Javaè™›æ‹Ÿæœºæ ˆç”¨äºç®¡ç†Javaæ–¹æ³•çš„è°ƒç”¨ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆç”¨äºç®¡ç†æœ¬åœ°æ–¹æ³•çš„è°ƒç”¨**ã€‚

æœ¬åœ°æ–¹æ³•æ ˆï¼Œä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚

å…è®¸è¢«å®ç°æˆå›ºå®šæˆ–è€…æ˜¯å¯åŠ¨æ€æ‰©å±•çš„å†…å­˜å¤§å°ã€‚( åœ¨å†…å­˜æº¢å‡ºæ–¹é¢æ˜¯ç›¸åŒçš„)

* â¢ å¦‚æœçº¿ç¨‹è¯·æ±‚åˆ†é…çš„æ ˆå®¹é‡è¶…è¿‡æœ¬åœ°æ–¹æ³•æ ˆå…è®¸çš„æœ€å¤§å®¹é‡ï¼ŒJavaè™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ª `stackoverflowError` å¼‚å¸¸ã€‚
* â¢ å¦‚æœæœ¬åœ°æ–¹æ³•æ ˆå¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œå¹¶ä¸”åœ¨å°è¯•æ‰©å±•çš„æ—¶å€™æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼Œæˆ–è€…åœ¨åˆ›å»ºæ–°çš„çº¿ç¨‹æ—¶æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å»åˆ›å»ºå¯¹åº”çš„æœ¬åœ°æ–¹æ³•æ ˆï¼Œé‚£ä¹ˆJavaè™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ª `outOfMemoryError` å¼‚å¸¸ã€‚

æœ¬åœ°æ–¹æ³•æ˜¯ä½¿ç”¨Cè¯­è¨€å®ç°çš„ã€‚

å®ƒçš„å…·ä½“åšæ³•æ˜¯Native Method Stackä¸­ç™»è®°nativeæ–¹æ³•ï¼Œåœ¨Execution Engine æ‰§è¡Œæ—¶åŠ è½½æœ¬åœ°æ–¹æ³•åº“ã€‚

**å½“æŸä¸ªçº¿ç¨‹è°ƒç”¨ä¸€ä¸ªæœ¬åœ°æ–¹æ³•æ—¶ï¼Œå®ƒå°±è¿›å…¥äº†ä¸€ä¸ªå…¨æ–°çš„å¹¶ä¸”ä¸å†å—è™šæ‹Ÿæœºé™åˆ¶çš„ä¸–ç•Œã€‚å®ƒå’Œè™šæ‹Ÿæœºæ‹¥æœ‰åŒæ ·çš„æƒé™**ã€‚

* â¢ æœ¬åœ°æ–¹æ³•å¯ä»¥é€šè¿‡æœ¬åœ°æ–¹æ³•æ¥å£æ¥**è®¿é—®è™šæ‹Ÿæœºå†…éƒ¨çš„è¿è¡Œæ—¶æ•°æ®åŒº**ã€‚
* â¢ å®ƒç”šè‡³å¯ä»¥ç›´æ¥ä½¿ç”¨æœ¬åœ°å¤„ç†å™¨ä¸­çš„å¯„å­˜å™¨
* â¢ ç›´æ¥ä»æœ¬åœ°å†…å­˜çš„å †ä¸­åˆ†é…ä»»æ„æ•°é‡çš„å†…å­˜ã€‚

â— **å¹¶ä¸æ˜¯æ‰€æœ‰çš„JVMéƒ½æ”¯æŒæœ¬åœ°æ–¹æ³•ã€‚å› ä¸ºJavaè™šæ‹Ÿæœºè§„èŒƒå¹¶æ²¡æœ‰æ˜ç¡®è¦æ±‚æœ¬åœ°æ–¹æ³•æ ˆçš„ä½¿ç”¨è¯­è¨€ã€å…·ä½“å®ç°æ–¹å¼ã€æ•°æ®ç»“æ„ç­‰**ã€‚å¦‚æœJVMäº§å“ä¸æ‰“ç®—æ”¯æŒnativeæ–¹æ³•ï¼Œä¹Ÿå¯ä»¥æ— éœ€å®ç°æœ¬åœ°æ–¹æ³•æ ˆã€‚

â— åœ¨Hotspot JVMä¸­ï¼Œç›´æ¥å°†æœ¬åœ°æ–¹æ³•æ ˆå’Œè™šæ‹Ÿæœºæ ˆåˆäºŒä¸ºä¸€ã€‚
