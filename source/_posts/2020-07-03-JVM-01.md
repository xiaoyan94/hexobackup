---
title: JVM 01 ç±»åŠ è½½å™¨åŠç±»åŠ è½½è¿‡ç¨‹
date: 2020-07-03 16:13:14
tags: [Java,JVM]
---

## æ¦‚è¿°ç±»çš„åŠ è½½å™¨åŠç±»åŠ è½½è¿‡ç¨‹

* ç±»çš„åŠ è½½è¿‡ç¨‹ä¸€ï¼š Loading åŠ è½½
* ç±»çš„åŠ è½½è¿‡ç¨‹äºŒï¼š Linking é“¾æ¥
  * Verification éªŒè¯
  * Preparation å‡†å¤‡
  * Resolution è§£æ
* ç±»çš„åŠ è½½è¿‡ç¨‹ä¸‰ï¼š Initialization åˆå§‹åŒ–

<!-- more -->

### æ¦‚è¿°ç±»çš„åŠ è½½å™¨

Javaç¯å¢ƒï¼š Java 8

#### ç±»åŠ è½½å™¨å­ç³»ç»Ÿä½œç”¨

* ç±»åŠ è½½å™¨å­ç³»ç»Ÿè´Ÿè´£ä»æ–‡ä»¶ç³»ç»Ÿæˆ–è€…ç½‘ç»œä¸­åŠ è½½Classæ–‡ä»¶ï¼Œclassæ–‡ä»¶åœ¨æ–‡ä»¶å¼€å¤´æœ‰ç‰¹å®šçš„æ–‡ä»¶æ ‡è¯†ã€‚
* ClassLoaderåªè´Ÿè´£classæ–‡ä»¶çš„åŠ è½½ï¼Œè‡³äºå®ƒæ˜¯å¦å¯ä»¥è¿è¡Œï¼Œåˆ™ç”±Execution Engineå†³å®šã€‚
* åŠ è½½çš„ç±»ä¿¡æ¯å­˜æ”¾äºä¸€å—ç§°ä¸ºæ–¹æ³•åŒºçš„å†…å­˜ç©ºé—´ã€‚é™¤äº†ç±»çš„ä¿¡æ¯å¤–ï¼Œæ–¹æ³•åŒºä¸­è¿˜ä¼šå­˜æ”¾è¿è¡Œæ—¶å¸¸é‡æ± ä¿¡æ¯ï¼Œå¯èƒ½è¿˜åŒ…æ‹¬å­—ç¬¦ä¸²å­—é¢é‡å’Œæ•°å­—å¸¸é‡(è¿™éƒ¨åˆ†å¸¸é‡ä¿¡æ¯æ˜¯Classæ–‡ä»¶ä¸­å¸¸é‡æ± éƒ¨åˆ†çš„å†…å­˜æ˜ å°„)

#### ç±»åŠ è½½å™¨ClassLoaderè§’è‰²

1. class file å­˜åœ¨äºæœ¬åœ°ç¡¬ç›˜ä¸Šï¼Œå¯ä»¥ç†è§£ä¸ºè®¾è®¡å¸ˆç”»åœ¨çº¸ä¸Šçš„æ¨¡æ¿ï¼Œè€Œæœ€ç»ˆè¿™ä¸ªæ¨¡æ¿åœ¨æ‰§è¡Œçš„æ—¶å€™æ˜¯è¦åŠ è½½åˆ°JVMå½“ä¸­æ¥æ ¹æ®è¿™ä¸ªæ–‡ä»¶å®ä¾‹åŒ–å‡ºnä¸ªä¸€æ¨¡ä¸€æ ·çš„å®ä¾‹ã€‚
2. class file åŠ è½½åˆ°JVMä¸­,è¢«ç§°ä¸ºDNAå…ƒæ•°æ®æ¨¡æ¿,æ”¾åœ¨æ–¹æ³•åŒºã€‚
3. åœ¨.classæ–‡ä»¶-> JVM ->æœ€ç»ˆæˆä¸ºå…ƒæ•°æ®æ¨¡æ¿,æ­¤è¿‡ç¨‹å°±è¦ä¸€ä¸ªè¿è¾“å·¥å…·(ç±»è£…è½½å™¨Class Loader) ,æ‰®æ¼”ä¸€ä¸ªå¿«é€’å‘˜çš„è§’è‰²ã€‚

### ç±»çš„åŠ è½½è¿‡ç¨‹

* Loading åŠ è½½
* Linking é“¾æ¥
  * Verification éªŒè¯
  * Preparation å‡†å¤‡
  * Resolution è§£æ
* Initialization åˆå§‹åŒ–

#### åŠ è½½

1. é€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåè·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµ
2. å°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„
3. åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„java.lang.Classå¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£

è¡¥å……:åŠ è½½.class æ–‡ä»¶çš„æ–¹å¼

* ä»æœ¬åœ°ç³»ç»Ÿä¸­ç›´æ¥åŠ è½½
* é€šè¿‡ç½‘ç»œè·å–ï¼Œå…¸å‹åœºæ™¯: Web Applet
* ä»zipå‹ç¼©åŒ…ä¸­è¯»å–ï¼Œæˆä¸ºæ—¥åjarã€waræ ¼å¼çš„åŸºç¡€
* è¿è¡Œæ—¶è®¡ç®—ç”Ÿæˆï¼Œä½¿ç”¨æœ€å¤šçš„æ˜¯:åŠ¨æ€ä»£ç†æŠ€æœ¯
* ç”±å…¶ä»–æ–‡ä»¶ç”Ÿæˆï¼Œå…¸å‹åœºæ™¯: JSPåº”ç”¨
* ä»ä¸“æœ‰æ•°æ®åº“ä¸­æå–.classæ–‡ä»¶ï¼Œæ¯”è¾ƒå°‘è§
* ä»åŠ å¯†æ–‡ä»¶ä¸­è·å–ï¼Œå…¸å‹çš„é˜²Classæ–‡ä»¶è¢«åç¼–è¯‘çš„ä¿æŠ¤æªæ–½

#### é“¾æ¥

éªŒè¯(Verify) :

* ç›®çš„åœ¨äºç¡®ä¿Classæ–‡ä»¶çš„å­—èŠ‚æµä¸­åŒ…å«ä¿¡æ¯ç¬¦åˆå½“å‰è™šæ‹Ÿæœºè¦æ±‚ï¼Œä¿è¯è¢«åŠ è½½ç±»çš„æ­£ç¡®æ€§ï¼Œä¸ä¼šå±å®³è™šæ‹Ÿæœºè‡ªèº«å®‰å…¨ã€‚
* ä¸»è¦åŒ…æ‹¬å››ç§éªŒè¯ï¼Œæ–‡ä»¶æ ¼å¼éªŒè¯ï¼Œå…ƒæ•°æ®éªŒè¯ï¼Œå­—èŠ‚ç éªŒè¯ï¼Œç¬¦å·å¼•ç”¨éªŒè¯ã€‚

å‡†å¤‡(Prepare) :

* ä¸ºç±»å˜é‡åˆ†é…å†…å­˜å¹¶ä¸”è®¾ç½®è¯¥ç±»å˜é‡çš„é»˜è®¤åˆå§‹å€¼ï¼Œå³é›¶å€¼ã€‚
* è¿™é‡Œä¸åŒ…å«ç”¨finalä¿®é¥°çš„static,å› ä¸ºfinalåœ¨ç¼–è¯‘çš„æ—¶å€™å°±ä¼šåˆ†é…äº†ï¼Œå‡†å¤‡é˜¶æ®µä¼šæ˜¾å¼åˆå§‹åŒ–;
* è¿™é‡Œä¸ä¼šä¸ºå®ä¾‹å˜é‡åˆ†é…åˆå§‹åŒ–ï¼Œç±»å˜é‡ä¼šåˆ†é…åœ¨æ–¹æ³•åŒºä¸­ï¼Œè€Œå®ä¾‹å˜é‡æ˜¯ä¼šéšç€å¯¹è±¡ä¸€èµ·åˆ†é…åˆ°Javaå †ä¸­ã€‚

è§£æ(Resolve) :

* å°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ã€‚
* äº‹å®ä¸Šï¼Œè§£ææ“ä½œå¾€å¾€ä¼šä¼´éšç€JVMåœ¨æ‰§è¡Œå®Œåˆå§‹åŒ–ä¹‹åå†æ‰§è¡Œã€‚
* ç¬¦å·å¼•ç”¨å°±æ˜¯ä¸€ç»„ç¬¦å·æ¥æè¿°æ‰€å¼•ç”¨çš„ç›®æ ‡ã€‚ç¬¦å·å¼•ç”¨çš„å­—é¢é‡å½¢å¼æ˜ç¡®å®šä¹‰åœ¨ã€Šjavaè™šæ‹Ÿæœºè§„èŒƒã€‹çš„Classæ–‡ä»¶æ ¼å¼ä¸­ã€‚ç›´æ¥å¼•ç”¨å°±æ˜¯ç›´æ¥æŒ‡å‘ç›®æ ‡çš„æŒ‡é’ˆã€ç›¸å¯¹åç§»é‡æˆ–ä¸€ä¸ªé—´æ¥å®šä½åˆ°ç›®æ ‡çš„å¥æŸ„ã€‚
* è§£æåŠ¨ä½œä¸»è¦é’ˆå¯¹ç±»æˆ–æ¥å£ã€å­—æ®µã€ç±»æ–¹æ³•ã€æ¥å£æ–¹æ³•ã€æ–¹æ³•ç±»å‹ç­‰ã€‚å¯¹åº”å¸¸é‡æ± ä¸­çš„ CONSTANT_Class_infoã€ CONSTANT_Fieldref_infoã€ CONSTANT_Methodref_infoç­‰ ã€‚

#### åˆå§‹åŒ–

* **åˆå§‹åŒ–é˜¶æ®µå°±æ˜¯æ‰§è¡Œç±»æ„é€ å™¨æ–¹æ³•\<clinit>()çš„è¿‡ç¨‹ã€‚**
* æ­¤æ–¹æ³•ä¸éœ€å®šä¹‰ï¼Œæ˜¯javacç¼–è¯‘å™¨è‡ªåŠ¨æ”¶é›†ç±»ä¸­çš„æ‰€æœ‰ç±»å˜é‡çš„èµ‹å€¼åŠ¨ä½œå’Œé™æ€ä»£ç å—ä¸­çš„è¯­å¥åˆå¹¶è€Œæ¥ã€‚
* æ„é€ å™¨æ–¹æ³•ä¸­æŒ‡ä»¤æŒ‰è¯­å¥åœ¨æºæ–‡ä»¶ä¸­å‡ºç°çš„é¡ºåºæ‰§è¡Œã€‚
* **\<clinit>()ä¸åŒäºç±»çš„æ„é€ å™¨ã€‚(å…³è”:æ„é€ å™¨æ˜¯è™šæ‹Ÿæœºè§†è§’ä¸‹çš„\<init>())**
* è‹¥è¯¥ç±»å…·æœ‰çˆ¶ç±»ï¼ŒJVMä¼šä¿è¯å­ç±»çš„\<clinit>()æ‰§è¡Œå‰ï¼Œçˆ¶ç±»çš„\<clinit>()å·²ç»æ‰§è¡Œå®Œæ¯•ã€‚
* è™šæ‹Ÿæœºå¿…é¡»ä¿è¯ä¸€ä¸ªç±»çš„\<clinit>()æ–¹æ³•åœ¨å¤šçº¿ç¨‹ä¸‹è¢«åŒæ­¥åŠ é”ã€‚

---

#### ç›¸å…³ä»£ç 

ClassInitTest.java

```java
package com.example.java;

public class ClassInitTest {
    private static int num = 1;

    static {
        num = 2;
        number = 20;
        // System.out.println(num); //ä¸ä¼šæŠ¥é”™
        // System.out.println(number);// æŠ¥é”™ï¼Œéæ³•çš„å‰å‘å¼•ç”¨ Illegal forward reference
    }

    private static int number = 10; //linkingä¹‹prepare: number = 0 --> initial: 20 --> 10

    public static void main(String[] args) {
        System.out.println(ClassInitTest.num);//2
        System.out.println(ClassInitTest.number);//10
    }
}
```

ClassInitTest.class

å­—èŠ‚ç æ–‡ä»¶ï¼šMethod - \<clinit> -  code

```java
 0 iconst_1
 1 putstatic #3 <com/example/java/ClassInitTest.num>
 4 iconst_2
 5 putstatic #3 <com/example/java/ClassInitTest.num>
 8 bipush 20
10 putstatic #5 <com/example/java/ClassInitTest.number>
13 bipush 10
15 putstatic #5 <com/example/java/ClassInitTest.number>
18 return

```

---

ClinitTest.java

```java
package com.example.java;

public class ClinitTest {
    //ä»»ä½•ä¸€ä¸ªç±»å£°æ˜ä»¥åï¼Œå†…éƒ¨è‡³å°‘å­˜åœ¨ä¸€ä¸ªç±»çš„æ„é€ å™¨
    private int a = 1;
    private static int c = 3;

    public static void main(String[] args) {
        int b = 2;
    }

    public ClinitTest() {
        a = 10;
        int d = 20;
    }

}
```

ClinitTest.class

å­—èŠ‚ç æ–‡ä»¶ï¼šMethod - \<clinit> -  code

```java
 iconst_3
1 putstatic #3 <com/example/java/ClinitTest.c>
4 return
```

å­—èŠ‚ç æ–‡ä»¶ï¼šMethod - \<init> -  code

```java
0 aload_0
 1 invokespecial #1 <java/lang/Object.<init>>
 4 aload_0
 5 iconst_1
 6 putfield #2 <com/example/java/ClinitTest.a>
 9 aload_0
10 bipush 10
12 putfield #2 <com/example/java/ClinitTest.a>
15 bipush 20
17 istore_1
18 return
```

---

å¤šçº¿ç¨‹ï¼ŒéªŒè¯ \<clinit>() æ–¹æ³•è¢«åŒæ­¥åŠ é”ï¼š

```java
package com.example.java;

public class DeadThreadTest {
    public static void main(String[] args) {
        Runnable r = () -> {
            System.out.println(Thread.currentThread().getName() + "å¼€å§‹");
            DeadThread dead = new DeadThread();
            System.out.println(Thread.currentThread().getName() + "ç»“æŸ");
        };
        Thread t1 = new Thread(r, "çº¿ç¨‹1 ");
        Thread t2 = new Thread(r, "çº¿ç¨‹2 ");
        t1.start();
        t2.start();
    }
}

class DeadThread {
    static {
        if (true) {
            System.out.println(Thread.currentThread().getName() + "åˆå§‹åŒ–å½“å‰ç±»");
            while (true) {

            }
        }
    }
}

```

ç¨‹åºè¾“å‡ºï¼š

```bash
çº¿ç¨‹1 å¼€å§‹
çº¿ç¨‹2 å¼€å§‹
çº¿ç¨‹1 åˆå§‹åŒ–å½“å‰ç±»

Process finished with exit code 130 (interrupted by signal 2: SIGINT)
```

æˆ–è€…æ˜¯

```bash
çº¿ç¨‹2 å¼€å§‹
çº¿ç¨‹1 å¼€å§‹
çº¿ç¨‹2 åˆå§‹åŒ–å½“å‰ç±»

Process finished with exit code 130 (interrupted by signal 2: SIGINT)
```

---

### ç±»åŠ è½½å™¨çš„åˆ†ç±»

* JVMæ”¯æŒä¸¤ç§ç±»å‹çš„ç±»åŠ è½½å™¨ï¼Œåˆ†åˆ«ä¸º**å¼•å¯¼ç±»åŠ è½½å™¨ (Bootstrap ClassLoader)** å’Œ**è‡ªå®šä¹‰ç±»åŠ è½½å™¨(User-Defined ClassLoader)** ã€‚
* ä»æ¦‚å¿µä¸Šæ¥è®²ï¼Œè‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¸€èˆ¬æŒ‡çš„æ˜¯ç¨‹åºä¸­ç”±å¼€å‘äººå‘˜è‡ªå®šä¹‰çš„ä¸€ç±»ç±»åŠ è½½å™¨ï¼Œä½†æ˜¯Javaè™šæ‹Ÿæœºè§„èŒƒå´æ²¡æœ‰è¿™ä¹ˆå®šä¹‰ï¼Œè€Œæ˜¯**å°†æ‰€æœ‰æ´¾ç”ŸäºæŠ½è±¡ç±» `ClassLoader` çš„ç±»åŠ è½½å™¨éƒ½åˆ’åˆ†ä¸ºè‡ªå®šä¹‰ç±»åŠ è½½å™¨ã€‚**
* æ— è®ºç±»åŠ è½½å™¨çš„ç±»å‹å¦‚ä½•åˆ’åˆ†ï¼Œåœ¨ç¨‹åºä¸­æˆ‘ä»¬æœ€å¸¸è§çš„ç±»åŠ è½½å™¨å§‹ç»ˆåªæœ‰3ä¸ªï¼Œå¦‚ä¸‹æ‰€ç¤º:
  * Bootstrap Class Loader
  * Extension Class Loader
  * System Class Loader
  * User Defined Class Loader

è¿™é‡Œçš„å››è€…ä¹‹é—´çš„å…³ç³»æ˜¯åŒ…å«å…³ç³»ã€‚ä¸æ˜¯ä¸Šå±‚ä¸‹å±‚ï¼Œä¹Ÿä¸æ˜¯å­çˆ¶ç±»çš„ç»§æ‰¿å…³ç³»ã€‚

---

ClassLoaderTest.java

```java
package com.example.java;

public class ClassLoaderTest {
    public static void main(String[] args) {
        //è·å–ç³»ç»Ÿç±»åŠ è½½å™¨
        ClassLoader systemClassLoader = ClassLoader.getSystemClassLoader();
        System.out.println(systemClassLoader);//sun.misc.Launcher$AppClassLoader@18b4aac2
        //è·å–å…¶ä¸Šå±‚: æ‰©å±•ç±»åŠ è½½å™¨
        ClassLoader extClassLoader = systemClassLoader.getParent();
        System.out.println(extClassLoader);//sun.misc.Launcher$ExtClassLoader@1540e19d
        //è·å–å…¶ä¸Šå±‚: è·å–ä¸åˆ°å¼•å¯¼ç±»åŠ è½½å™¨
        ClassLoader bootstrapClassLoader = extClassLoader.getParent();
        System.out.println(bootstrapClassLoader);//null
        //å¯¹äºç”¨æˆ·è‡ªå®šä¹‰ç±»æ¥è¯´: é»˜è®¤ä½¿ç”¨ç³»ç»Ÿç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½
        ClassLoader classLoader = ClassLoaderTest.class.getClassLoader();
        System.out.println(classLoader);//sun.misc.Launcher$AppClassLoader@18b4aac2
        //Stringç±»ä½¿ç”¨å¼•å¯¼ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½çš„ã€‚---> Javaçš„æ ¸å¿ƒç±»åº“éƒ½æ˜¯ä½¿ç”¨å¼•å¯¼ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½çš„ã€‚
        ClassLoader classLoader1 = String.class.getClassLoader();
        System.out.println(classLoader1);//null
    }
}
```

è¾“å‡ºï¼š

```java
sun.misc.Launcher$AppClassLoader@18b4aac2
sun.misc.Launcher$ExtClassLoader@61bbe9ba
null
sun.misc.Launcher$AppClassLoader@18b4aac2
null

Process finished with exit code 0
```

---

#### è™šæ‹Ÿæœºè‡ªå¸¦çš„åŠ è½½å™¨

å¯åŠ¨ç±»åŠ è½½å™¨(å¼•å¯¼ç±»åŠ è½½å™¨ï¼ŒBootstrap ClassLoader)

* â¢ è¿™ä¸ªç±»åŠ è½½ä½¿ç”¨C/C++è¯­è¨€å®ç°çš„ï¼ŒåµŒå¥—åœ¨JVMå†…éƒ¨ã€‚
* â¢ å®ƒç”¨æ¥åŠ è½½Javaçš„æ ¸å¿ƒåº“( `JAVA_ HOME/jre/lib/rt.jar` ã€`resources.jar` æˆ– `sun.boot.class.path` è·¯å¾„ä¸‹çš„å†…å®¹) , ç”¨äºæä¾›JVMè‡ªèº«éœ€è¦çš„ç±»
* â¢ å¹¶ä¸ç»§æ‰¿è‡ª `java.lang.ClassLoader` ,æ²¡æœ‰çˆ¶åŠ è½½å™¨ã€‚
* â¢ åŠ è½½æ‰©å±•ç±»å’Œåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼Œå¹¶æŒ‡å®šä¸ºä»–ä»¬çš„çˆ¶ç±»åŠ è½½å™¨ã€‚
* â¢ å‡ºäºå®‰å…¨è€ƒè™‘ï¼ŒBootstrapå¯åŠ¨ç±»åŠ è½½å™¨åªåŠ è½½åŒ…åä¸º `javaã€javaxã€sun` ç­‰å¼€å¤´çš„ç±»

æ‰©å±•ç±»åŠ è½½å™¨(Extension ClassLoader)

* â¢ **Javaè¯­è¨€ç¼–å†™**ï¼Œç”± `sun.misc.Launcher$ExtClassLoader` å®ç°ã€‚
* â¢ **æ´¾ç”Ÿäº `ClassLoader` ç±»**
* â¢ çˆ¶ç±»åŠ è½½å™¨ä¸ºå¯åŠ¨ç±»åŠ è½½å™¨
* â¢ ä» `java.ext.dirs` ç³»ç»Ÿå±æ€§æ‰€æŒ‡å®šçš„ç›®å½•ä¸­åŠ è½½ç±»åº“ï¼Œæˆ–ä»JDKçš„å®‰è£…ç›®å½•çš„ `jre/lib/ext` å­ç›®å½•(æ‰©å±•ç›®å½•)ä¸‹åŠ è½½ç±»åº“ã€‚å¦‚æœç”¨æˆ·åˆ›å»ºçš„JARæ”¾åœ¨æ­¤ç›®å½•ä¸‹ï¼Œä¹Ÿä¼šè‡ªåŠ¨ç”±æ‰©å±•ç±»åŠ è½½å™¨åŠ è½½ã€‚

åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨(ç³»ç»Ÿç±»åŠ è½½å™¨ï¼ŒAppClassLoader)

* â¢ javaè¯­è¨€ç¼–å†™ï¼Œç”± `sun.misc.Launcher$AppClassLoader` å®ç°
* â¢ æ´¾ç”Ÿäº `ClassLoader` ç±»
* â¢ çˆ¶ç±»åŠ è½½å™¨ä¸ºæ‰©å±•ç±»åŠ è½½å™¨
* â¢ å®ƒè´Ÿè´£åŠ è½½ç¯å¢ƒå˜é‡classpathæˆ–ç³»ç»Ÿå±æ€§ `java.class.path` æŒ‡å®šè·¯å¾„ä¸‹çš„ç±»åº“
* â¢ **è¯¥ç±»åŠ è½½æ˜¯ç¨‹åºä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨**ï¼Œä¸€èˆ¬æ¥è¯´ï¼ŒJavaåº”ç”¨çš„ç±»éƒ½æ˜¯ç”±å®ƒæ¥å®ŒæˆåŠ è½½
* â¢ é€šè¿‡ `ClassLoader#getSystemClassLoader()` æ–¹æ³•å¯ä»¥è·å–åˆ°è¯¥ç±»åŠ è½½å™¨

---

```java
package com.example.java;

import java.net.URL;
import java.security.Provider;

public class ClassLoaderTest1 {
    public static void main(String[] args) {
        System.out.println("******å¯åŠ¨ç±»åŠ è¼‰å™¨*******");
        //è»å–BootstrapClassLoaderèƒ½å¤ŸåŠ æ ½çš„apiçš„è·¯å¾„
        URL[] urLs = sun.misc.Launcher.getBootstrapClassPath().getURLs();
        for (URL element : urLs) {
            System.out.println(element.toExternalForm());
        }
        //ä»ä¸Šé¢çš„è·¯å¾„ä¸­éšæ„é€‰æ‹©ä¸€ä¸ªç¾, æ¥çœ‹çœ‹ä»–çš„ç±»åŠ è¼‰å™¨æ˜¯ä»€ä¹ˆ:
        ClassLoader classLoader = Provider.class.getClassLoader();
        System.out.println(classLoader); // null

        System.out.println("******æ‰©å±•ç±»åŠ è¼‰å™¨******");
        String extDirs = System.getProperty("java.ext.dirs");

        // macOSä¸‹ç¯å¢ƒå˜é‡çš„åˆ†éš”ç¬¦æ˜¯:
        // Windowsä¸‹åˆ†éš”ç¬¦æ˜¯;
        for (String path : extDirs.split(":")) {
            System.out.println(path);
        }

        //ä»ä¸Šé¢çš„è·¯å¾„ä¸­éšæ„é€‰æ‹©ä¸€ä¸ªç±»ï¼Œæ¥çœ‹çœ‹ä»–çš„ç±»åŠ è½½å™¨æ˜¯ä»€ä¹ˆ:æ‰©å±•ç±»åŠ è½½å™¨
        ClassLoader classLoader1 = CurveDB.class.getClassLoader();
        System.out.println(classLoader1);//sun.misc.Launcher$ExtClassLoader@1540e19d
    }
}
```

è¾“å‡ºï¼š

```bash
******å¯åŠ¨ç±»åŠ è¼‰å™¨*******
file:/Library/Java/JavaVirtualMachines/jdk1.8.0_251.jdk/Contents/Home/jre/lib/resources.jar
file:/Library/Java/JavaVirtualMachines/jdk1.8.0_251.jdk/Contents/Home/jre/lib/rt.jar
file:/Library/Java/JavaVirtualMachines/jdk1.8.0_251.jdk/Contents/Home/jre/lib/sunrsasign.jar
file:/Library/Java/JavaVirtualMachines/jdk1.8.0_251.jdk/Contents/Home/jre/lib/jsse.jar
file:/Library/Java/JavaVirtualMachines/jdk1.8.0_251.jdk/Contents/Home/jre/lib/jce.jar
file:/Library/Java/JavaVirtualMachines/jdk1.8.0_251.jdk/Contents/Home/jre/lib/charsets.jar
file:/Library/Java/JavaVirtualMachines/jdk1.8.0_251.jdk/Contents/Home/jre/lib/jfr.jar
file:/Library/Java/JavaVirtualMachines/jdk1.8.0_251.jdk/Contents/Home/jre/classes
null
******æ‰©å±•ç±»åŠ è¼‰å™¨******
/Users/yan/Library/Java/Extensions
/Library/Java/JavaVirtualMachines/jdk1.8.0_251.jdk/Contents/Home/jre/lib/ext
/Library/Java/Extensions
/Network/Library/Java/Extensions
/System/Library/Java/Extensions
/usr/lib/java
sun.misc.Launcher$ExtClassLoader@355da254

Process finished with exit code 0
```

---

#### ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨

* åœ¨Javaçš„æ—¥å¸¸åº”ç”¨ç¨‹åºå¼€å‘ä¸­ï¼Œç±»çš„åŠ è½½å‡ ä¹æ˜¯ç”±ä¸Šè¿°3ç§ç±»åŠ è½½å™¨ç›¸äº’é…åˆæ‰§è¡Œçš„ï¼Œåœ¨å¿…è¦æ—¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œæ¥å®šåˆ¶ç±»çš„åŠ è½½æ–¹å¼ã€‚
* ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰ç±»åŠ è½½å™¨?
  * â¢ éš”ç¦»åŠ è½½ç±»
  * â¢ ä¿®æ”¹ç±»åŠ è½½çš„æ–¹å¼
  * â¢ æ‰©å±•åŠ è½½æº
  * â¢ é˜²æ­¢æºç æ³„æ¼

ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨å®ç°æ­¥éª¤:

1. å¼€å‘äººå‘˜å¯ä»¥é€šè¿‡ç»§æ‰¿æŠ½è±¡ç±» `java.lang.ClassLoader` ç±»çš„æ–¹å¼ï¼Œå®ç°è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œä»¥æ»¡è¶³ä¸€äº›ç‰¹æ®Šçš„éœ€æ±‚
2. åœ¨JDK1.2ä¹‹å‰ï¼Œåœ¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œæ€»ä¼šå»ç»§æ‰¿ `ClassLoader` ç±»å¹¶é‡å†™ `loadClass()` æ–¹æ³•ï¼Œä»è€Œå®ç°è‡ªå®šä¹‰çš„ç±»åŠ è½½ç±»ï¼Œä½†æ˜¯åœ¨JDK1.2ä¹‹åå·²ä¸å†å»ºè®®ç”¨æˆ·å»è¦†ç›– `loadClass()` æ–¹æ³•ï¼Œè€Œæ˜¯å»ºè®®æŠŠè‡ªå®šä¹‰çš„ç±»åŠ è½½é€»è¾‘å†™åœ¨ `findClass()` æ–¹æ³•ä¸­
3. åœ¨ç¼–å†™è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œå¦‚æœæ²¡æœ‰å¤ªè¿‡äºå¤æ‚çš„éœ€æ±‚ï¼Œå¯ä»¥ç›´æ¥ç»§æ‰¿ `URLClassLoader` ç±»ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…è‡ªå·±å»ç¼–å†™ `findClass()` æ–¹æ³•åŠå…¶è·å–å­—èŠ‚ç æµçš„æ–¹å¼ï¼Œä½¿è‡ªå®šä¹‰ç±»åŠ è½½å™¨ç¼–å†™æ›´åŠ ç®€æ´ã€‚

---

æ‰‹å†™è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼š

```java
package com.example.java;

import java.io.FileNotFoundException;

public class CustomClassLoader extends ClassLoader {
    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        try {
            byte[] result = getClassFromCustomPath(name);
            if (result == null) {
                throw new FileNotFoundException();
            } else {
                return defineClass(name, result, 0, result.length); //
                // findClasså’ŒdefineClassé…åˆä½¿ç”¨
            }
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        }
        throw new ClassNotFoundException(name);
    }

    private byte[] getClassFromCustomPath(String name) {
        //ä»è‡ªå®šä¹‰è·¯å¾„ä¸­åŠ è½½æŒ‡å®šç±»:ç»†èŠ‚ç•¥
        //å¦‚æœæŒ‡å®šè·¯å¾„çš„å­—èŠ‚ç æ–‡ä»¶è¿›è¡Œäº†åŠ å¯†ï¼Œåˆ™éœ€è¦åœ¨æ­¤æ–¹æ³•ä¸­è¿›è¡Œè§£å¯†æ“ä½œã€‚
        return null;
    }
}
```

---

ClassLoaderç±»ï¼Œ å®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå…¶åæ‰€æœ‰çš„ç±»åŠ è½½å™¨éƒ½ç»§æ‰¿è‡ª ClassLoader (ä¸åŒ…æ‹¬å¯åŠ¨ç±»åŠ è½½å™¨)

> æ–¹æ³•åç§° | æè¿°
> -----|---
> getParent() | è¿”å›è¯¥ç±»åŠ è½½å™¨çš„è¶…ç±»åŠ è½½å™¨
> loadClass(String name) | åŠ è½½åç§°ä¸ºnameçš„ç±»ï¼Œè¿”å›ç»“æœä¸º `java.lang.Class` ç±»çš„å®ä¾‹
> findClass(String name) | æŸ¥æ‰¾åç§°ä¸ºnameçš„ç±»ï¼Œè¿”å›ç»“æœä¸º `java.lang.Class` ç±»çš„å®ä¾‹
> findLoadedClass(String name) | æŸ¥æ‰¾åç§°ä¸ºnameçš„å·²ç»è¢«åŠ è½½è¿‡çš„ç±»ï¼Œè¿”å›ç»“æœä¸º `java.lang.Class` ç±»çš„å®ä¾‹
> defineClass(String name, byte[] b, int off, int len) | æŠŠå­—èŠ‚æ•°ç»„bä¸­çš„å†…å®¹è½¬æ¢ä¸ºä¸€ä¸ªJavaç±»ï¼Œè¿”å›ç»“æœä¸º `java.lang.Class` ç±»çš„å®ä¾‹
> resolveClass(Class<?> c) | è¿æ¥æŒ‡å®šçš„ä¸€ä¸ªJavaç±»

è·å–ClassLoaderçš„é€”å¾„

| æ–¹å¼                                   | æ–¹æ³•                                           |
| -------------------------------------- | ---------------------------------------------- |
| æ–¹å¼ä¸€: è·å–å½“å‰ç±»çš„ClassLoader         | clazz.getClassLoader()                         |
| æ–¹å¼äºŒ: è·å–å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡çš„ClassLoader | Thread.currentThread().getContextClassLoader() |
| æ–¹å¼ä¸‰: è·å–ç³»ç»Ÿçš„ClassLoader           | ClassLoader.getSystemClassLoader()             |
| æ–¹å¼å››: è·å–è°ƒç”¨è€…çš„ClassLoader         | DriverManager.getCallerClassLoader()           |

#### ğŸŒ¿ åŒäº²å§”æ´¾æœºåˆ¶

Javaè™šæ‹Ÿæœºå¯¹classæ–‡ä»¶é‡‡ç”¨çš„æ˜¯**æŒ‰éœ€åŠ è½½**çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯´å½“éœ€è¦ä½¿ç”¨è¯¥ç±»æ—¶æ‰ä¼šå°†å®ƒçš„classæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ç”Ÿæˆclasså¯¹è±¡ã€‚è€Œä¸”åŠ è½½æŸä¸ªç±»çš„classæ–‡ä»¶æ—¶ï¼ŒJavaè™›æ‹Ÿæœºé‡‡ç”¨çš„æ˜¯**åŒäº²å§”æ´¾æ¨¡å¼**ï¼Œå³æŠŠè¯·æ±‚äº¤ç”±çˆ¶ç±»å¤„ç†ï¼Œå®ƒæ˜¯ä¸€ç§ä»»åŠ¡å§”æ´¾æ¨¡å¼ã€‚

â— å·¥ä½œåŸç†

1) å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½è¯·æ±‚ï¼Œå®ƒå¹¶ä¸ä¼šè‡ªå·±å…ˆå»åŠ è½½ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ‰˜ç»™çˆ¶ç±»çš„åŠ è½½å™¨å»æ‰§è¡Œ;
2) å¦‚æœçˆ¶ç±»åŠ è½½å™¨è¿˜å­˜åœ¨å…¶çˆ¶ç±»åŠ è½½å™¨ï¼Œåˆ™è¿›ä¸€æ­¥å‘ä¸Šå§”æ‰˜ï¼Œä¾æ¬¡é€’å½’ï¼Œè¯·æ±‚æœ€ç»ˆå°†åˆ°è¾¾é¡¹å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨;
3) å¦‚æœçˆ¶ç±»åŠ è½½å™¨å¯ä»¥å®Œæˆç±»åŠ è½½ä»»åŠ¡ï¼Œå°±æˆåŠŸè¿”å›ï¼Œå€˜è‹¥çˆ¶ç±»åŠ è½½å™¨æ— æ³•å®Œæˆæ­¤åŠ è½½ä»»åŠ¡ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½ï¼Œè¿™å°±æ˜¯åŒäº²å§”æ´¾æ¨¡å¼ã€‚

---

åŒäº²å§”æ´¾æœºåˆ¶ä¸¾ä¾‹ï¼šè‡ªå·±æ‰‹å†™ä¸€ä¸ªStringç±»æ”¾åœ¨è‡ªå»ºçš„java.langåŒ…ä¸‹ï¼š

```java
package java.lang;

public class String {
    //
    static {
        System.out.println("æˆ‘æ˜¯è‡ªå®šä¹‰çš„Stringç±»çš„é™æ€ä»£ç å—");
    }

    public static void main(String[] args) {
        System.out.println("hello,String");
    }
}
```

è¿è¡Œï¼Œè¾“å‡ºï¼š

```java
é”™è¯¯: åœ¨ç±» java.lang.String ä¸­æ‰¾ä¸åˆ° main æ–¹æ³•, è¯·å°† main æ–¹æ³•å®šä¹‰ä¸º:
   public static void main(String[] args)
å¦åˆ™ JavaFX åº”ç”¨ç¨‹åºç±»å¿…é¡»æ‰©å±•javafx.application.Application

Process finished with exit code 1
```

*ä¸ºä»€ä¹ˆæœ‰ä»¥ä¸Šè¾“å‡ºï¼Ÿ*

ç”±äºåŒäº²å§”æ´¾æœºåˆ¶ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ `java.lang.String` ç±»å¹¶ä¸æ˜¯ç”±ç³»ç»Ÿç±»åŠ è½½å™¨åŠ è½½çš„ï¼Œè€Œæ˜¯å‘ä¸Šå§”æ‰˜ç»™äº†æ‰©å±•ç±»åŠ è½½å™¨åˆæ¥ç€å‘ä¸Šå§”æ‰˜ç»™äº†å¯åŠ¨ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œè€Œå¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½çš„æ˜¯javaæ ¸å¿ƒAPIä¸­çš„ `java.lang.String` ç±»è€Œä¸æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ `java.lang.String` ç±»ï¼Œå…¶ä¸­å¹¶æ²¡æœ‰mainæ–¹æ³•ã€‚

---

åŒäº²å§”æ´¾æœºåˆ¶ä¸¾ä¾‹2

rt.jar SPIï¼ˆService Provider Interfaceï¼‰æ ¸å¿ƒç±»
jdbc.jar SPIæ¥å£å®ç°ç±»

rt.jarä¸­çš„SPIæ¥å£è°ƒç”¨æ¥å£å®ç°ç±»ä¸­çš„æ–¹æ³•ï¼š

* SPIæ¥å£æ˜¯ç”±å¼•å¯¼ç±»åŠ è½½å™¨ï¼ˆBootstrapClassLoaderï¼‰åŠ è½½çš„
* SPIæ¥å£å®ç°ç±»æ˜¯ç”±çº¿ç¨‹ä¸Šä¸‹æ–‡åŠ è½½å™¨ï¼ˆContextClassLoaderï¼‰åŠ è½½çš„ï¼Œè€Œçº¿ç¨‹ä¸Šä¸‹æ–‡åŠ è½½å™¨é»˜è®¤ä¸ºç³»ç»Ÿç±»åŠ è½½å™¨ï¼ˆAppClassLoaderï¼‰åŠ è½½çš„

---

â— åŒäº²å§”æ´¾æœºåˆ¶ ä¼˜åŠ¿

* â¢ é¿å…ç±»çš„é‡å¤åŠ è½½ ï¼ˆä¸¤ä¸ªå¿…è¦æ¡ä»¶ï¼‰
* â¢ ä¿æŠ¤ç¨‹åºå®‰å…¨ï¼Œé˜²æ­¢æ ¸å¿ƒAPIè¢«éšæ„ç¯¡æ”¹
  * è‡ªå®šä¹‰ç±»: java.lang.String
  * è‡ªå®šä¹‰ç±»: java.lang.ShkStart
    * java.lang.SecurityException: Prohibited package name; java.lang

â— åœ¨JVMä¸­ è¡¨ç¤ºä¸¤ä¸ªclasså¯¹è±¡æ˜¯å¦ä¸ºåŒä¸€ä¸ªç±»å­˜åœ¨ä¸¤ä¸ªå¿…è¦æ¡ä»¶:

* â¢ ç±»çš„å®Œæ•´ç±»åå¿…é¡»ä¸€è‡´ï¼ŒåŒ…æ‹¬åŒ…åã€‚
* â¢ åŠ è½½è¿™ä¸ªç±»çš„ClassLoader (æŒ‡ClassLoaderå®ä¾‹å¯¹è±¡)å¿…é¡»ç›¸åŒã€‚

æ¢å¥è¯è¯´ï¼Œåœ¨JVMä¸­ï¼Œå³ä½¿è¿™ä¸¤ä¸ªç±»å¯¹è±¡(classå¯¹è±¡)æ¥æºåŒä¸€ä¸ªClassæ–‡ä»¶ï¼Œè¢«åŒä¸€ä¸ªè™šæ‹Ÿæœºæ‰€åŠ è½½ï¼Œä½†åªè¦åŠ è½½å®ƒä»¬çš„ClassLoaderå®ä¾‹å¯¹è±¡ä¸åŒï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªç±»å¯¹è±¡ä¹Ÿæ˜¯ä¸ç›¸ç­‰çš„ã€‚

è‡ªå®šä¹‰Stringç±»ï¼Œä½†æ˜¯åœ¨åŠ è½½è‡ªå®šä¹‰Stringç±»çš„æ—¶å€™ä¼šç‡å…ˆä½¿ç”¨å¼•å¯¼ç±»åŠ è½½å™¨åŠ è½½ï¼Œè€Œå¼•å¯¼ç±»åŠ è½½å™¨åœ¨åŠ è½½çš„è¿‡ç¨‹ä¸­ä¼šå…ˆåŠ è½½jdkè‡ªå¸¦çš„æ–‡ä»¶(rt.jaråŒ…ä¸­java\lang\String.class)ï¼ŒæŠ¥é”™ä¿¡æ¯è¯´æ²¡æœ‰mainæ–¹æ³•ï¼Œå°±æ˜¯å› ä¸ºåŠ è½½çš„æ˜¯rt.jaråŒ…ä¸­çš„Stringç±»ã€‚è¿™æ ·å¯ä»¥ä¿è¯å¯¹javaæ ¸å¿ƒæºä»£ç çš„ä¿æŠ¤ï¼Œè¿™å°±æ˜¯**æ²™ç®±å®‰å…¨æœºåˆ¶**ã€‚

---

### å¯¹ç±»åŠ è½½å™¨çš„å¼•ç”¨ã€ç±»çš„ä¸»åŠ¨ä½¿ç”¨å’Œè¢«åŠ¨ä½¿ç”¨

å¯¹ç±»åŠ è½½å™¨çš„å¼•ç”¨ï¼š

JVMå¿…é¡»çŸ¥é“ä¸€ä¸ªç±»å‹æ˜¯ç”±å¯åŠ¨åŠ è½½å™¨åŠ è½½çš„è¿˜æ˜¯ç”±ç”¨æˆ·ç±»åŠ è½½å™¨åŠ è½½çš„ã€‚å¦‚æœä¸€ä¸ªç±»å‹æ˜¯ç”±ç”¨æˆ·ç±»åŠ è½½å™¨åŠ è½½çš„ï¼Œé‚£ä¹ˆJVMä¼š**å°†è¿™ä¸ªç±»åŠ è½½å™¨çš„ä¸€ä¸ªå¼•ç”¨ä½œä¸ºç±»å‹ä¿¡æ¯çš„ä¸€éƒ¨åˆ†ä¿å­˜åœ¨æ–¹æ³•åŒºä¸­**ã€‚å½“è§£æä¸€ä¸ªç±»å‹åˆ°å¦ä¸€ä¸ªç±»å‹çš„å¼•ç”¨çš„æ—¶å€™ï¼ŒJVMéœ€è¦ä¿è¯è¿™ä¸¤ä¸ªç±»å‹çš„ç±»åŠ è½½å™¨æ˜¯ç›¸åŒçš„ã€‚

ç±»çš„ä¸»åŠ¨ä½¿ç”¨å’Œè¢«åŠ¨ä½¿ç”¨ï¼š

**Javaç¨‹åºå¯¹ç±»çš„ä½¿ç”¨æ–¹å¼åˆ†ä¸º: ä¸»åŠ¨ä½¿ç”¨å’Œè¢«åŠ¨ä½¿ç”¨ã€‚**  
â— ä¸»åŠ¨ä½¿ç”¨ï¼Œåˆåˆ†ä¸ºä¸ƒç§æƒ…å†µ:

* â¢ åˆ›å»ºç±»çš„å®ä¾‹
* â¢ è®¿é—®æŸä¸ªç±»æˆ–æ¥å£çš„é™æ€å˜é‡ï¼Œæˆ–è€…å¯¹è¯¥é™æ€å˜é‡èµ‹å€¼
* â¢ è°ƒç”¨ç±»çš„é™æ€æ–¹æ³•
* â¢ åå°„(æ¯”å¦‚: `Class.forName("com.atguigu.Test")` )
* â¢ åˆå§‹åŒ–ä¸€ä¸ªç±»çš„å­ç±»
* â¢ Javaè™šæ‹Ÿæœºå¯åŠ¨æ—¶è¢«æ ‡æ˜ä¸ºå¯åŠ¨ç±»çš„ç±»
* â¢ JDK 7å¼€å§‹æä¾›çš„åŠ¨æ€è¯­è¨€æ”¯æŒ:
  * `java.lang.invoke.MethodHandle` å®ä¾‹çš„è§£æç»“æœ
  * `REF_getStatic`ã€ `REF_putStatic`ã€ `REF_invokeStatic` å¥æŸ„å¯¹åº”çš„ç±»æ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™åˆå§‹åŒ–

â— é™¤äº†ä»¥ä¸Šä¸ƒç§æƒ…å†µï¼Œå…¶ä»–ä½¿ç”¨Javaç±»çš„æ–¹å¼éƒ½è¢«çœ‹ä½œæ˜¯**å¯¹ç±»çš„è¢«åŠ¨ä½¿ç”¨ï¼Œéƒ½ä¸ä¼šå¯¼è‡´ç±»çš„åˆå§‹åŒ–**ã€‚
